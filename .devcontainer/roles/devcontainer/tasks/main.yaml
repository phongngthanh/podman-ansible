- name: Setup precommit
  block:
    - name: Setup precommit hook
      community.general.git_config:
        name: init.templateDir
        scope: global
        value: ~/.git-template
    - name: Setup precommit template
      ansible.builtin.command:
        cmd: pre-commit init-templatedir -t pre-commit ~/.git-template
      changed_when: false

- name: Setup ansible repo
  block:
    - name: Check if repo contain ansible code
      ansible.builtin.find:
        paths: ../
        recurse: true
        patterns:
          - ansible.cfg
      register: ansible_repo_state

    - name: Setup ansible repo
      when: ansible_repo_state.matched > 0
      block:
        - name: Setup gitignore
          ansible.builtin.set_fact:
            gitignore_list: "{{ gitignore_list + ['ansible'] }}"
        - name: Check current installed version of ansible-lint
          community.general.pip_package_info:
          register: pip_package_info
        - name: Set ansible-lint version
          ansible.builtin.set_fact:
            ansible_lint_version: "{{ pip_package_info.packages.pip['ansible-lint'][0].version }}"
        - name: Setup yamllint
          ansible.builtin.template:
            src: .yamllint.yaml.j2
            dest: ../.yamllint.yaml
            mode: "0644"
        - name: Setup ansible-lint
          ansible.builtin.template:
            src: .ansible-lint.j2
            dest: ../.ansible-lint
            mode: "0644"
        - name: Check if requirements file exists
          ansible.builtin.stat:
            path: ../requirements.yaml
          register: ansible_requirements_state
        - name: Install requirements
          when: ansible_requirements_state.stat.exists
          changed_when: false
          ansible.builtin.command:
            chdir: ../
            cmd: ansible-galaxy install -r requirements.yaml

- name: Setup python repo
  block:
    - name: Check if repo contain python code
      ansible.builtin.find:
        paths: ../
        recurse: true
        patterns:
          - "*.py"
      register: python_repo_state

    - name: Setup ansible repo
      when: python_repo_state.matched > 0
      block:
        - name: Setup gitignore
          ansible.builtin.set_fact:
            gitignore_list: "{{ gitignore_list + ['python'] }}"

- name: Setup gitignore file
  block:
    - name: Set gitignore template URL
      ansible.builtin.set_fact:
        gitignore_url: https://www.toptal.com/developers/gitignore/api/{{ gitignore_list | sort | join(',') }}
    - name: Get gitignore template
      ansible.builtin.set_fact:
        gitignore_template: "{{ lookup('ansible.builtin.url', gitignore_url, wantlist=true) }}"
    - name: Setup gitignore
      ansible.builtin.template:
        src: .gitignore.j2
        dest: ../.gitignore
        mode: "0644"

- name: Setup precommit
  block:
    - name: Setup precommit file for repo
      ansible.builtin.template:
        src: .pre-commit-config.yaml.j2
        dest: ../.pre-commit-config.yaml
        mode: "0644"
    - name: Install precommit
      ansible.builtin.command:
        chdir: ../
        cmd: pre-commit install
      changed_when: false
