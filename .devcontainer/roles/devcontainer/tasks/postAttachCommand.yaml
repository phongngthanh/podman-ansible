- name: Setup precommit
  block:
    - name: Setup precommit hook
      community.general.git_config:
        name: init.templateDir
        scope: global
        value: ~/.git-template
    - name: Setup precommit template
      ansible.builtin.command:
        cmd: pre-commit init-templatedir -t pre-commit ~/.git-template
      changed_when: false

- name: Setup ansible repo
  block:
    - name: Install requirements
      changed_when: false
      ansible.builtin.command:
        chdir: ../
        cmd: ansible-galaxy install -r requirements.yaml

- name: Setup terraform repo
  block:
    - name: Setup gitignore
      ansible.builtin.set_fact:
        gitignore_list: "{{ gitignore_list + ['terraform'] }}"
    - name: Setup terraform plugin cache
      ansible.builtin.copy:
        dest: "{{ ansible_user_dir }}/.terraformrc"
        mode: "0644"
        content: |
          plugin_cache_dir = "${HOME}/.terraform-plugin-cache"

- name: Setup gitignore file
  block:
    - name: Set gitignore template URL
      ansible.builtin.set_fact:
        devcontainer_gitignore_url: https://www.toptal.com/developers/gitignore/api/{{ gitignore_list | sort | join(',') }}
    - name: Setup gitignore # noqa: var-naming[no-role-prefix]
      ansible.builtin.template:
        src: .gitignore.j2
        dest: ../.gitignore
        mode: "0644"
      vars:
        devcontainer_gitignore_template: "{{ lookup('ansible.builtin.url', devcontainer_gitignore_url, wantlist=true) }}"

- name: Setup precommit
  block:
    - name: Install precommit
      ansible.builtin.command:
        chdir: ../
        cmd: pre-commit install
      changed_when: false
