- name: Setup the yaml file if not exists
  ansible.builtin.copy:
    dest: "{{ yaml_file_path }}"
    content: |
      ---
    force: false
    mode: "0644"

- name: Load yaml file
  ansible.builtin.slurp:
    src: "{{ yaml_file_path }}"
  register: yaml_file

- name: Convert yaml
  ansible.builtin.set_fact:
    yaml_file: "{{ yaml_file.content | b64decode | from_yaml_all | list }}"

- name: Edit yaml
  ansible.builtin.set_fact:
    yaml_file: "{{ yaml_file | default([]) | combine(yaml_edit, recursive=true, list_merge='append_rp') }}"

- name: Write yaml to file
  ansible.builtin.copy:
    content: "{{ yaml_file | to_nice_yaml(sort_keys=false, indent=2, width=1337) }}" # noqa: jinja[invalid]
    dest: "{{ yaml_file_path }}"
    mode: "0644"
