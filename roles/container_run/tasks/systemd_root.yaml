- name: "Check if {{ service_name }} systemd file exists"
  ansible.builtin.stat:
    path: "/lib/systemd/system/{{ service_name }}.service"
  register: systemd_state

- name: "Install {{ service_name }} systemd"
  ansible.builtin.command:
    chdir: /lib/systemd/system
    cmd: "podman generate systemd --new --name --files --no-header --container-prefix '' --pod-prefix '' --separator '' {{ service_name }}"
  register: systemd_files
  when: service_state == "started"

- name: "Enable {{ service_name }} systemd service"
  ansible.builtin.systemd:
    daemon_reload: yes
    enabled: yes
    name: "{{ service_name }}"
    state: started
  when: service_state == "started"
  register: systemd_state
  retries: 6
  until: systemd_state.failed == false

- name: "Disable {{ service_name }} systemd service"
  ansible.builtin.systemd:
    daemon_reload: yes
    enabled: no
    name: "{{ service_name }}"
    state: stopped
  when: service_state == "absent" and systemd_state.stat.exists
# TODO: Remove systemd service files
# - name: "Remove {{ service_name }} systemd files"
#   ansible.builtin.file:
#     path: "{{ item }}"
#     state: absent
#   loop: "{{ systemd_files.stdout_lines }}"
#   when: service_state == "absent" and not systemd_files
