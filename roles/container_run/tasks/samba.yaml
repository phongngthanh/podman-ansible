- name: Prepare data folder
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
  loop:
    - "{{ global_storage }}"

- name: Stop systemd
  ansible.builtin.systemd:
    name: samba
    daemon_reload: true
    enabled: true
    scope: user
    state: stopped
  ignore_errors: true

- name: Samba
  containers.podman.podman_container:
    name: samba
    image: "{{ samba_image }}"
    network: host
    env:
      WSDD2_DISABLE: 1
      AVAHI_DISABLE: 1
      ACCOUNT_root: "{{ samba_password }}"
      UID_root: 0
      GROUP_root: 0
      SAMBA_VOLUME_CONFIG_root: "[Storage]; path=/shares/storage; valid users = root; guest ok = no; read only = no; browseable = yes"
      SAMBA_GLOBAL_CONFIG_case_SPACE_sensitive: "yes" # Need this option for case sensitive files. Reference: https://www.oreilly.com/openbook/samba/book/ch05_04.html
    generate_systemd:
      container_prefix: ""
      new: true
      path: /home/{{ ansible_user }}/.config/systemd/user
      pod_prefix: ""
      separator: ""
    restart_policy: on-failure
    state: "{{ samba_state }}"
    volumes:
      - "{{ global_storage }}:/shares/storage"
  register: container
  until: container.failed == false

- name: Enable systemd
  ansible.builtin.systemd:
    name: samba
    daemon_reload: true
    enabled: true
    scope: user
    state: "{{ samba_state }}"
  register: service
  until: service.failed == false
