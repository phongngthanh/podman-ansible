- name: Create Caddy config folder
  file:
    path: "{{ caddy_data_config }}"
    state: directory

- name: Create Caddy data folder
  file:
    path: "{{ caddy_data_data }}"
    state: directory

- name: Caddyfile
  copy:
    src: "caddy/Caddyfile"
    dest: "{{ caddy_data_caddyfile }}"
  notify:
    - Restart Caddy

- name: Stop systemd
  vars:
    service_name: caddy
  import_tasks: systemd_stop.yaml

- name: Caddy
  containers.podman.podman_container:
    name: caddy
    image: "{{ caddy_image }}"
    env:
      CADDYFILE_AUTH_TOKEN: "{{ caddy_caddyfile_auth_token }}"
      CADDYFILE_BASIC_AUTH_PASS: "{{ caddy_caddyfile_basic_auth_pass }}"
      CADDYFILE_BASIC_AUTH_USER: "{{ caddy_caddyfile_basic_auth_user }}"
      CADDYFILE_HOST_ADDRESS: "{{ caddy_caddyfile_host_address }}"
      CADDYFILE_PROXY_SITE: "{{ server_domain }}"
      CADDYFILE_ZEROSSL_EMAIL: "{{ caddy_caddyfile_zerossl_email }}"
    network:
      - caddy
    ports:
      - "80:80/tcp"
      - "443:443/tcp"
      - "443:443/udp"
    volumes:
      - "/etc/localtime:/etc/localtime:ro,z"
      - "{{ caddy_data_caddyfile }}:/etc/caddy/Caddyfile:U,ro,z"
      - "{{ caddy_data_config }}:/config:U,z"
      - "{{ caddy_data_data }}:/data:U,z"
    # restart_policy: "on-failure"
    state: "{{ caddy_state }}"
# To execute the restart immediately
# - name: Flush handlers
#   meta: flush_handlers

- name: Install systemd
  vars:
    service_name: caddy
    service_state: "{{ caddy_state }}"
  import_tasks: systemd.yaml
