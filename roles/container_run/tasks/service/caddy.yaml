- name: Caddyfile
  ansible.builtin.template:
    src: "caddy/Caddyfile.j2"
    dest: "{{ caddy_data_caddyfile }}"
    mode: "0600"
  register: restart_caddy

- name: Caddy
  containers.podman.podman_container:
    env:
      TZ: "{{ global_timezone }}"
    generate_systemd:
      container_prefix: ""
      new: true
      path: /home/{{ ansible_user }}/.config/systemd/user
      pod_prefix: ""
      separator: ""
    image: "{{ caddy_image }}"
    name: caddy
    network:
      - caddy
    ports:
      - 80:80/tcp
      - 443:443/tcp
      - 443:443/udp
    restart_policy: on-failure
    state: "{{ caddy_state }}"
    volumes:
      - "{{ caddy_data_caddyfile }}:/etc/caddy/Caddyfile:U,ro,z"
      - "{{ caddy_data_config }}:/config:U,z"
      - "{{ caddy_data_data }}:/data:U,z"
  register: container
  until: container.failed == false

# Need this since handlers doesn't work with include. Issues: https://github.com/ansible/ansible/issues/19765
- name: Restart caddy if caddyfile is changed
  ansible.builtin.systemd:
    daemon_reload: yes
    enabled: yes
    name: caddy
    scope: user
    state: restarted
  when: restart_caddy.changed
