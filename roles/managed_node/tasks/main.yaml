- name: Setup networking
  ansible.builtin.import_tasks: system/network.yaml
  tags: network

- name: Harden ssh
  ansible.builtin.import_tasks: system/ssh.yaml
  when: ansible_user != "root"

- name: Setup hostname
  ansible.builtin.import_tasks: system/hostname.yaml

- name: Setup Podman
  ansible.builtin.import_tasks: system/podman.yaml
  tags: podman

- name: Install packages
  ansible.builtin.import_tasks: system/packages.yaml
  tags: packages

- name: Setup systemd
  ansible.builtin.include_tasks:
    file: systemd.yaml
    apply:
      tags: systemd
  loop: "{{ systemd_services }}"
  loop_control:
    loop_var: systemd_loop_var
  vars:
    systemd_name: "{{ systemd_loop_var.name }}"
    systemd_scope: "{{ systemd_loop_var.scope | default('user') }}"
    systemd_state: "{{ systemd_loop_var.state | default('started') }}"
    systemd_schedule: "{{ systemd_loop_var.schedule | default('') }}"
  tags: systemd

- name: Setup storage mounts
  ansible.builtin.import_tasks: system/mount.yaml
  tags: mount

- name: Setup mergerfs_directory service
  ansible.builtin.import_tasks: user/mergerfs_directory.yaml
  tags: mergerfs_directory

- name: Setup snapraid
  ansible.builtin.import_tasks: system/snapraid.yaml

- name: Setup Virtualization
  ansible.builtin.import_tasks: system/virtualization.yaml
  tags: virt

- name: Setup nvidia driver
  ansible.builtin.import_tasks: system/nvidia.yaml
  tags: nvidia

# - name: Install crowdsec
#   ansible.builtin.import_tasks: system/crowdsec.yaml
#   tags: crowdsec

- name: Install netdata
  ansible.builtin.import_role:
    name: netdata

- name: Miscellaneous settings
  ansible.builtin.import_tasks: system/misc.yaml
  tags: misc

- name: Automatic update packages
  ansible.builtin.import_tasks: system/auto_update.yaml
  tags: auto_update
