- tags: podman_install
  become: true
  block:
    - name: Podman
      ansible.builtin.dnf:
        name:
          - podman-docker
          - slirp4netns
        state: latest

    - name: Install podman
      ansible.builtin.dnf:
        name:
          - podman
        state: latest

    - name: Setup privileged ports for rootless podman
      ansible.builtin.sysctl:
        name: net.ipv4.ip_unprivileged_port_start
        sysctl_set: true
        value: "80"

- name: Enable podman autoupdate timer
  ansible.builtin.systemd:
    daemon_reload: true
    enabled: true
    name: podman-auto-update.timer
    scope: user
    state: started

- name: Enable podman autoupdate timer for root
  become: true
  ansible.builtin.systemd:
    daemon_reload: true
    enabled: true
    name: podman-auto-update.timer
    state: started

- name: Enable podman socket
  ansible.builtin.systemd:
    daemon_reload: true
    enabled: true
    name: podman.socket
    scope: user
    state: started

- name: Edit podman configuration
  community.general.ini_file:
    path: /home/{{ ansible_user }}/.config/containers/containers.conf
    section: "{{ item.section }}"
    option: "{{ item.option }}"
    value: "{{ item.value }}"
  loop: "{{ podman_configuration }}"

# Remove lock file before renumbering. Reference: https://github.com/containers/podman/issues/9164
- name: Remove libpod rootless lock
  ansible.builtin.file:
    path: /dev/shm/libpod_rootless_lock_{{ ansible_effective_group_id }}
    state: absent

# Reference: https://docs.podman.io/en/latest/markdown/podman-system-renumber.1.html
- name: Renumber podman locks
  ansible.builtin.command:
    cmd: podman system renumber
