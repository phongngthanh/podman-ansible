- name: "Check if user {{ ansible_user }} is lingering"
  stat:
    path: "/var/lib/systemd/linger/{{ ansible_user }}"
  register: user_lingering

- name: Enable lingering if neccessary
  command: "loginctl enable-linger {{ ansible_user }}"
  when:
    - not user_lingering.stat.exists

- name: Template the systemd service
  vars:
    template_var: "{{ item }}"
  ansible.builtin.template:
    src: "user/{{ item.name }}.service.j2"
    dest: "/home/{{ ansible_user }}/.config/systemd/user/{{ item.name }}.service"
  loop: "{{ systemd.user.service }}"
  notify: Run the systemd service

- name: Enable the systemd service
  ansible.builtin.systemd:
    daemon_reload: yes
    scope: user
    enabled: yes
    state: restarted
    name: "{{ item.name }}"
  loop: "{{ systemd.user.service }}"
  when: item.enable is defined

- name: Template the timer
  vars:
    template_var: "{{ item }}"
  ansible.builtin.template:
    src: "user/{{ item.name }}.timer.j2"
    dest: "/home/{{ ansible_user }}/.config/systemd/user/{{ item.name }}.timer"
  loop: "{{ systemd.user.timer }}"
  when: item.timer is defined
  notify: Run the systemd timer
