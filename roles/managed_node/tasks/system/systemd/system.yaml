- name: Setup system
  become: true
  block:
    - name: Template system systemd service
      vars:
        template_var: "{{ item }}"
      ansible.builtin.template:
        src: "system/{{ item.name }}.service.j2"
        dest: "/etc/systemd/system/{{ item.name }}.service"
        mode: "0600"
      loop: "{{ systemd.system }}"

    - name: Enable system systemd service
      ansible.builtin.systemd:
        daemon_reload: true
        enabled: true
        state: started
        name: "{{ item.name }}"
      loop: "{{ systemd.system }}"
      when: not item.schedule is defined

    - name: Setyp systemd timer
      ansible.builtin.include_role:
        name: systemd_timer
      loop: "{{ systemd.system }}"
      vars:
        systemd_description: "{{ item.description }}"
        systemd_name: "{{ item.name }}"
        systemd_schedule: "{{ item.schedule }}"
        systemd_scope: system
        systemd_state: "{{ item.state }}"
      when: item.schedule is defined
