- name: Setup system
  become: true
  block:
    - name: Template system systemd service
      vars:
        template_var: "{{ item }}"
      ansible.builtin.template:
        src: "system/{{ item.name }}.service.j2"
        dest: "/etc/systemd/system/{{ item.name }}.service"
        mode: "0600"
      loop: "{{ systemd.system }}"

    - name: Enable system systemd service
      ansible.builtin.systemd:
        daemon_reload: true
        enabled: true
        state: started
        name: "{{ item.name }}"
      loop: "{{ systemd.system }}"
      when: item.timer is not defined

    - name: Template system timer
      vars:
        template_var: "{{ item }}"
      ansible.builtin.template:
        src: "user/template.timer.j2"
        dest: "/etc/systemd/system/{{ item.name }}.timer"
        mode: "0600"
      loop: "{{ systemd.system }}"
      when: item.timer is defined

    - name: Enable the systemd timer
      vars:
        template_var: "{{ item }}"
      ansible.builtin.systemd:
        daemon_reload: true
        enabled: true
        state: "{{ item.state }}"
        name: "{{ item.name }}.timer"
      loop: "{{ systemd.system }}"
      when: item.timer is defined
