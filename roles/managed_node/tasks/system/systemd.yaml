- name: "Check if user {{ ansible_user }} is lingering"
  stat:
    path: "/var/lib/systemd/linger/{{ ansible_user }}"
  register: user_lingering

- name: Enable lingering if neccessary
  command: "loginctl enable-linger {{ ansible_user }}"
  when:
    - not user_lingering.stat.exists

- name: Template the ansible systemd service
  vars:
    systemd_description: "{{ item.systemd_description }}"
    systemd_playbook: "{{ item.name }}"
    command: "{{ item.command }}"
    systemd_working_directory: "{{ item.systemd_working_directory }}"
  ansible.builtin.template:
    src: container/ansible.service.j2
    dest: "/home/{{ ansible_user }}/.config/systemd/user/{{ item.name }}.service"
  loop: "{{ systemd.podman.service }}"
  notify: Run the systemd service

- name: Template the ansible timer
  vars:
    timer_description: "{{ item.systemd_description }}"
    timer: "{{ item.timer }}"
  ansible.builtin.template:
    src: container/ansible.timer.j2
    dest: "/home/{{ ansible_user }}/.config/systemd/user/{{ item.name }}.timer"
  loop: "{{ systemd.podman.service }}"
  when: item.timer is defined
  notify: Run the systemd timer
