- name: Install mergerfs
  become: true
  tags: mergerfs
  block:
    - name: Download mergerfs github releases
      ansible.builtin.get_url:
        mode: "0600"
        url: https://github.com/trapexit/mergerfs/releases/download/2.33.5/mergerfs-static-linux_amd64.tar.gz
        dest: /tmp/mergerfs.tar.gz
    - name: Create temporary directory
      ansible.builtin.file:
        path: /tmp/mergerfs
        mode: "0755"
        state: directory
    - name: Extract mergerfs
      ansible.builtin.unarchive:
        remote_src: true
        src: /tmp/mergerfs.tar.gz
        dest: /tmp/mergerfs
    - name: Move mergerfs binary to specified location
      changed_when: false
      ansible.builtin.command:
        chdir: /tmp/mergerfs
        cmd: mv {{ item }} /{{ item }}
      loop:
        - usr/local/bin/mergerfs
        - usr/local/bin/mergerfs-fusermount
        - usr/local/share/man/man1/mergerfs.1
    - name: Remove installation directory
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/mergerfs.tar.gz
        - /tmp/mergerfs

- name: Install snapraid
  become: true
  block:
    - name: Add repository
      ansible.builtin.yum_repository:
        name: copr:copr.fedorainfracloud.org:pauken:SnapRAID
        description: Copr repo for SnapRAID owned by pauken
        baseurl: https://download.copr.fedorainfracloud.org/results/pauken/SnapRAID/fedora-35-$basearch/
        skip_if_unavailable: true
        gpgcheck: true
        gpgkey: https://download.copr.fedorainfracloud.org/results/pauken/SnapRAID/pubkey.gpg
        repo_gpgcheck: false
        enabled: true
    - name: Install snapraid and dependencies
      ansible.builtin.dnf:
        name:
          - snapraid
          - snapper
        state: latest
    - name: Install snapraid-btrfs
      ansible.builtin.copy:
        src: submodules/snapraid-btrfs/snapraid-btrfs
        dest: /usr/local/bin/snapraid-btrfs
        mode: "0755"

- name: Install fd
  become: true
  ansible.builtin.dnf:
    name:
      - fd-find
    state: latest
  tags:
    - fd
