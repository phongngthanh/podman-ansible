- name: Setup podman
  tags: podman_install
  become: true
  block:
    - name: Install podman
      ansible.builtin.dnf:
        name:
          - podman
          - podman-docker
          - slirp4netns
        state: latest

    - name: Setup privileged ports for rootless podman
      ansible.posix.sysctl:
        name: net.ipv4.ip_unprivileged_port_start
        sysctl_set: true
        value: "80"

- name: Enable podman socket
  ansible.builtin.systemd:
    daemon_reload: true
    enabled: true
    name: podman.socket
    scope: user
    state: started

- name: Install mergerfs
  become: true
  tags: mergerfs
  block:
    - name: Check if mergerfs is installed
      ansible.builtin.stat:
        path: /usr/local/bin/mergerfs
      register: mergerfs_install_state
    - name: Check mergerfs version
      when: mergerfs_install_state.stat.exists
      changed_when: false
      ansible.builtin.command:
        cmd: mergerfs --version
      register: mergerfs_current_version
    - name: Get mergerfs current version
      ansible.builtin.set_fact:
        mergerfs_current_version: "{{ mergerfs_current_version.stdout | regex_search('\\d.+\\d') }}"
      when: mergerfs_install_state.stat.exists
    - name: Install mergerfs
      when: (not mergerfs_install_state.stat.exists) or (mergerfs_current_version != mergerfs_version)
      block:
        - name: Download mergerfs github releases
          ansible.builtin.get_url:
            mode: "0600"
            url: https://github.com/trapexit/mergerfs/releases/download/{{ mergerfs_version }}/mergerfs-static-linux_{{ ansible_alternative_architecture }}.tar.gz
            dest: /tmp/mergerfs.tar.gz
        - name: Create temporary directory
          ansible.builtin.file:
            path: /tmp/mergerfs
            mode: "0755"
            state: directory
        - name: Extract mergerfs
          ansible.builtin.unarchive:
            remote_src: true
            src: /tmp/mergerfs.tar.gz
            dest: /tmp/mergerfs
        - name: Move mergerfs binary to specified location
          changed_when: false
          ansible.builtin.command:
            chdir: /tmp/mergerfs
            cmd: mv {{ item }} /{{ item }}
          loop:
            - usr/local/bin/mergerfs
            - usr/local/bin/mergerfs-fusermount
            - usr/local/share/man/man1/mergerfs.1
        - name: Remove installation directory
          ansible.builtin.file:
            path: "{{ item }}"
            state: absent
          loop:
            - /tmp/mergerfs.tar.gz
            - /tmp/mergerfs

- name: Install snapraid
  become: true
  block:
    - name: Add repository
      ansible.builtin.yum_repository:
        name: copr:copr.fedorainfracloud.org:pauken:SnapRAID
        description: Copr repo for SnapRAID owned by pauken
        baseurl: https://download.copr.fedorainfracloud.org/results/pauken/SnapRAID/fedora-35-$basearch/
        skip_if_unavailable: true
        gpgcheck: true
        gpgkey: https://download.copr.fedorainfracloud.org/results/pauken/SnapRAID/pubkey.gpg
        repo_gpgcheck: false
        enabled: true
    - name: Install snapraid and dependencies
      ansible.builtin.dnf:
        name:
          - snapraid
          - snapper
        state: latest
    - name: Install snapraid-btrfs
      ansible.builtin.copy:
        src: submodules/snapraid-btrfs/snapraid-btrfs
        dest: /usr/local/bin/snapraid-btrfs
        mode: "0755"

- name: Install fd
  become: true
  ansible.builtin.dnf:
    name:
      - fd-find
    state: latest
  tags:
    - fd
