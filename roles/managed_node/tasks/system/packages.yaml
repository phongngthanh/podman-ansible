- name: Check if Snapper repo is installed
  ansible.builtin.stat:
    path: /etc/yum.repos.d/snapper.repo
  register: snapper_repo_state
- name: Install snapper repo
  when: not snapper_repo_state.stat.exists
  become: true
  ansible.builtin.get_url:
    url: https://download.opensuse.org/repositories/filesystems:snapper/Fedora_{{ ansible_distribution_major_version }}/filesystems:snapper.repo
    dest: /etc/yum.repos.d/snapper.repo
    mode: "0600"

- name: Setup global packages
  become: true
  when: ansible_pkg_mgr != "atomic_container"
  ansible.builtin.dnf:
    name:
      - "@virtualization"
      - cockpit-machines
      - cockpit-podman
      - dnf-automatic
      - fd-find
      - fish
      - git
      - pip
      - podman
      - podman-docker
      - power-profiles-daemon
      - restic
      - slirp4netns
      - snapper
      - snapraid
    state: latest
- name: Setup virtualization
  tags: virt
  become: true
  block:
    - name: Allow virt to use fuse.mergerfs
      ansible.posix.seboolean:
        name: virt_use_fusefs
        state: true
        persistent: true

- name: Setup global packages
  become: true
  when: ansible_pkg_mgr == "atomic_container"
  community.general.rpm_ostree_pkg:
    name:
      - pip
      - power-profiles-daemon
      - restic
      - snapper
  register: rpm_ostree_pkg

- name: Reboot to apply rpm-ostree packages # noqa: no-handler
  become: true
  when: rpm_ostree_pkg.changed
  ansible.builtin.reboot:
    reboot_timeout: 600

- name: Setup podman
  tags: podman
  become: true
  vars:
    podman_config_dir_path: /etc/containers/containers.conf.d
  block:
    - name: Setup privileged ports for rootless podman
      ansible.posix.sysctl:
        name: net.ipv4.ip_unprivileged_port_start
        sysctl_set: true
        value: "80"

    - name: Setup podman configuration folder
      ansible.builtin.file:
        path: "{{ podman_config_dir_path }}"
        mode: "0755"
        state: directory

    - name: Setup podman configuration file root
      ansible.builtin.template:
        src: templates/podman/containers.conf.j2
        dest: "{{ podman_config_dir_path }}/containers.conf"
        mode: "0644"

- name: Setup rootless podman
  tags: podman
  vars:
    podman_config_dir_path: "{{ ansible_user_dir }}/.config/containers/containers.conf.d"
  block:
    - name: Enable podman socket
      ansible.builtin.systemd:
        daemon_reload: true
        enabled: true
        name: podman.socket
        scope: user
        state: started
    - name: Create containers config directory
      ansible.builtin.file:
        path: "{{ podman_config_dir_path }}"
        mode: "0755"
        state: directory
    - name: Setup podman configuration file user
      ansible.builtin.template:
        src: templates/podman/containers.conf.j2
        dest: "{{ podman_config_dir_path }}/containers.conf"
        mode: "0644"

- name: Install mergerfs
  become: true
  tags: mergerfs
  when: ansible_pkg_mgr != "atomic_container"
  block:
    - name: Check if mergerfs is installed
      ansible.builtin.stat:
        path: /usr/local/bin/mergerfs
      register: mergerfs_install_state
    - name: Check mergerfs version
      when: mergerfs_install_state.stat.exists
      changed_when: false
      ansible.builtin.command:
        cmd: mergerfs --version
      register: mergerfs_version_output
    - name: Install mergerfs
      vars:
        mergerfs_current_version: "{{ mergerfs_version_output.stdout | regex_search('\\d.+\\d') }}"
      when: (not mergerfs_install_state.stat.exists) or (mergerfs_current_version != mergerfs_version)
      block:
        - name: Download mergerfs github releases
          vars:
            architecture_dict:
              x86_64: amd64
              aarch64: arm64
            mergerfs_arch: "{{ architecture_dict[ansible_architecture] }}"
          ansible.builtin.get_url:
            mode: "0600"
            url: https://github.com/trapexit/mergerfs/releases/download/{{ mergerfs_version }}/mergerfs-static-linux_{{ mergerfs_arch }}.tar.gz
            dest: /tmp/mergerfs.tar.gz
        - name: Create temporary directory
          ansible.builtin.file:
            path: /tmp/mergerfs
            mode: "0755"
            state: directory
        - name: Extract mergerfs
          ansible.builtin.unarchive:
            remote_src: true
            src: /tmp/mergerfs.tar.gz
            dest: /tmp/mergerfs
        - name: Move mergerfs binary to specified location
          changed_when: false
          ansible.builtin.command:
            chdir: /tmp/mergerfs
            cmd: mv {{ item }} /{{ item }}
          loop:
            - usr/local/bin/mergerfs
            - usr/local/bin/mergerfs-fusermount
            - usr/local/share/man/man1/mergerfs.1
        - name: Remove installation directory
          ansible.builtin.file:
            path: "{{ item }}"
            state: absent
          loop:
            - /tmp/mergerfs.tar.gz
            - /tmp/mergerfs

- name: Setup low power mode
  become: true
  block:
    - name: Enable power-profiles-daemon
      ansible.builtin.systemd:
        name: power-profiles-daemon
        daemon_reload: true
        enabled: true
        state: started
    - name: Enable low power mode
      changed_when: false
      ansible.builtin.command:
        cmd: powerprofilesctl set power-saver

- name: Setup auto update dnf
  become: true
  block:
    - name: Enable automatic update timer # noqa: args[module]
      when: ansible_pkg_mgr != "atomic_container"
      ansible.builtin.systemd:
        name: dnf-automatic-install.timer
        daemon_reload: true
        enabled: true
        state: started
    - name: Enable automatic update service
      when: ansible_pkg_mgr == "atomic_container"
      ansible.builtin.systemd:
        name: rpm-ostreed-automatic.timer
        daemon_reload: true
        enabled: true
        state: started

- name: Enable cockpit
  become: true
  block:
    - name: Enable cockpit
      ansible.builtin.systemd:
        name: cockpit
        daemon_reload: true
        enabled: true
        state: started
