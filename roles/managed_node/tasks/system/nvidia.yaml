- name: Get fedora version
  ansible.builtin.command: # noqa: command-instead-of-module
    cmd: rpm -E %fedora
  changed_when: false
  register: fedora_version_output

- name: Setup nvidia driver
  become: true
  block:
    - name: Add rpm fusion repo non-free
      ansible.builtin.dnf:
        name: https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-{{ fedora_version_output.stdout }}.noarch.rpm
        disable_gpg_check: true
        state: present
    - name: Install nvidia driver
      ansible.builtin.dnf:
        name:
          - akmod-nvidia
          - xorg-x11-drv-nvidia-cuda # For cuda/nvdec/nvenc support
        state: latest
    # https://forums.developer.nvidia.com/t/nvidia-powerd-fails-to-start-on-fedora-36-510-68-02-driver/218254
    # Need to enable this driver since disabling it block reboot
    - name: Enable nvidia powerd service
      ansible.builtin.systemd:
        name: nvidia-powerd
        state: stopped
        daemon_reload: true
        masked: false
        enabled: true
    - name: Add nvidia container runtime repo
      ansible.builtin.get_url:
        url: https://nvidia.github.io/libnvidia-container/{{ nvidia_container_runtime_os }}/libnvidia-container.repo
        dest: /etc/yum.repos.d/nvidia-container-toolkit.repo
        mode: "0644"
    - name: Install nvidia container runtime
      ansible.builtin.dnf:
        name: nvidia-container-toolkit
        state: latest
    # https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#step-3-rootless-containers-setup
    - name: Add rootless support for nvidia gpu container runtime
      ansible.builtin.lineinfile:
        path: /etc/nvidia-container-runtime/config.toml
        regexp: ^#no-cgroups = false
        line: no-cgroups = true
    - name: Setup nvidia limit removal script
      ansible.builtin.script:
        cmd: submodules/nvidia-patch/patch.sh
