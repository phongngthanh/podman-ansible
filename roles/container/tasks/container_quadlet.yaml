- name: Create service {{ container_loop_var.key }}
  when: container_loop_var.value.state == "started"
  module_defaults:
    ansible.builtin.systemd:
      name: "{{ container_loop_var.key }}"
      daemon_reload: true
      state: started
      scope: "{{ container_systemd_scope }}"
  block:
    - name: Prepare kube deployment {{ container_loop_var.key }}
      delegate_to: localhost
      block:
        - name: Render kube deployment {{ container_loop_var.key }}
          changed_when: false
          ansible.builtin.command:
            chdir: cue
            cmd: cue dump --inject applicationName={{ container_loop_var.key }}
          register: cue_dump
    - name: Setup kube deployment {{ container_loop_var.key }}
      block:
        - name: Create kube deployment folder {{ container_loop_var.key }}
          ansible.builtin.file:
            path: "{{ ansible_user_dir }}/.config/containers/systemd/{{ container_loop_var.key }}"
            state: directory
            mode: "0755"
        - name: Copy kube files {{ container_loop_var.key }}
          ansible.builtin.copy:
            mode: "0755"
            src: "{{ container_loop_var.key }}/"
            dest: "{{ ansible_user_dir }}/.config/containers/systemd/{{ container_loop_var.key }}/"
          register: kube_file_container
        - name: Create kube deployment {{ container_loop_var.key }}
          ansible.builtin.copy:
            content: "{{ cue_dump.stdout }}"
            mode: "0600"
            dest: "{{ ansible_user_dir }}/.config/containers/systemd/{{ container_loop_var.key }}/deployment.yaml"
          register: kube_file_yaml
        - name: Create kube quadlet file {{ container_loop_var.key }}
          ansible.builtin.template:
            src: quadlet/service.kube.j2
            mode: "0600"
            dest: "{{ ansible_user_dir }}/.config/containers/systemd/{{ container_loop_var.key }}.kube"
          register: kube_file_quadlet
        - name: Start systemd service {{ container_loop_var.key }}
          ansible.builtin.systemd:
        - name: Restart systemd service if changed {{ container_loop_var.key }} # noqa: args[module]
          when: kube_file_container.changed or kube_file_yaml.changed or kube_file_quadlet.changed
          ansible.builtin.systemd:
            state: restarted
- name: Remove service {{ container_loop_var.key }}
  when: container_loop_var.value.state == "absent"
  module_defaults:
    ansible.builtin.systemd:
      name: "{{ container_loop_var.key }}"
      daemon_reload: true
      scope: "{{ container_systemd_scope }}"
      state: stopped
  block:
    - name: Check if kube file exists {{ container_loop_var.key }}
      ansible.builtin.stat:
        path: "{{ ansible_user_dir }}/.config/containers/systemd/{{ container_loop_var.key }}.kube"
      register: kube_file_exists
    - name: Stop systemd service {{ container_loop_var.key }}
      when: kube_file_exists.stat.exists
      ansible.builtin.systemd:
    - name: Remove kube file {{ container_loop_var.key }}
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ ansible_user_dir }}/.config/containers/systemd/{{ container_loop_var.key }}.kube"
        - "{{ ansible_user_dir }}/.config/containers/systemd/{{ container_loop_var.key }}"
