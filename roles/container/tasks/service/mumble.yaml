- name: Check if valid certificates is ready
  block:
    - name: Initialize certificates variables
      ansible.builtin.set_fact:
        cert_available: false
    - name: Check if certificates is available
      include_tasks:
        file: caddy_cert_check.yaml
        apply:
          vars:
            caddy_cert_domain: mumble.{{ server_domain }}
      loop: "{{ caddy_acme_ca_list }}"
    - name: Force tasks to fail if no valid cert is found
      ansible.builtin.fail:
        msg: No valid certificates is found
      when: not cert_available

- name: Mumble
  containers.podman.podman_container:
    env:
      TZ: "{{ global_timezone }}"
    generate_systemd:
      container_prefix: ""
      new: true
      path: /home/{{ ansible_user }}/.config/systemd/user
      pod_prefix: ""
      separator: ""
    image: "{{ mumble_image }}"
    name: mumble
    ports:
      - 64738:64738/tcp
      - 64738:64738/udp
    state: "{{ mumble_state }}"
    volumes:
      - "{{ mumble_volume_data }}:/data:U,z"
      - "{{ mumble_volume_config }}/murmur.ini:/etc/murmur.ini:ro,z"
      - "{{ caddy_cert_location }}:/certificates:ro,z"
  register: container
  until: container.failed == false
