- name: Check certificates for CA {{ item }}
  ansible.builtin.set_fact:
    caddy_cert_location_loop: "{{ caddy_data_data }}/caddy/certificates/{{ item }}/{{ caddy_cert_domain }}"
  when: not cert_available
- name: Check if folder is available {{ item + '/' + caddy_cert_domain }}
  ansible.builtin.stat:
    path: "{{ caddy_cert_location_loop }}/{{ caddy_cert_domain }}.crt"
  register: caddy_cert_status
  retries: 10
  until: caddy_cert_status.stat.exists
  ignore_errors: true
  when: not cert_available
- name: Set missing value for conditional check when this instance of the loop is skipped
  ansible.builtin.set_fact:
    caddy_cert_status:
      stat:
        exists: false
  when: not caddy_cert_status.stat.exists is defined
- name: Found certificates for {{ item + '/' + caddy_cert_domain }}
  ansible.builtin.set_fact:
    caddy_cert_location: "{{ caddy_data_data }}/caddy/certificates/{{ item }}/{{ caddy_cert_domain }}"
    cert_available: true
  when: caddy_cert_status.stat.exists
