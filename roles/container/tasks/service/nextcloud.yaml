- name: Nextcloud pod
  block:
    - name: Nextcloud
      containers.podman.podman_container:
        env:
          NEXTCLOUD_TRUTED_DOMAINS: "{{ nextcloud_trusted_domains }}"
          OVERWRITEPROTOCOL: https
          POSTGRES_DB: "{{ nextcloud_postgres_db }}"
          POSTGRES_HOST: localhost:5432
          POSTGRES_PASSWORD: "{{ nextcloud_postgres_password }}"
          POSTGRES_USER: "{{ nextcloud_postgres_user }}"
          REDIS_HOST: localhost
          REDIS_HOST_PASSWORD: "{{ nextcloud_redis_host_password }}"
          TZ: "{{ global_timezone }}"
        image: docker.io/nextcloud:stable@sha256:7d50c9c31de6016b9b1680a35332af27581e02145bda5e357d21d2cf758d2ca5
        name: nextcloud-web
        volumes:
          - "{{ nextcloud_volume_web_storage }}:/var/www/html/data:z"
          - "{{ nextcloud_volume_web_data }}:/var/www/html:z"
      when: nextcloud_db_action == "none"

    - name: Nextcloud chown
      ansible.builtin.command:
        cmd: podman exec -it nextcloud-web chown -R www-data:www-data ./
      changed_when: false

    - name: Nextcloud Redis
      containers.podman.podman_container:
        command: redis-server --requirepass {{ nextcloud_redis_host_password }}
        env:
          TZ: "{{ global_timezone }}"
        image: docker.io/redis:7-alpine@sha256:8158082a62d4dc96ce7492026bb0e0de012bee04a0a50a97a93244112611c60c
        name: nextcloud-redis
      when: nextcloud_db_action == "none"

    - name: Clean current database
      when: nextcloud_db_action == "import"
      block:
        - name: Remove current database
          become: true
          ansible.builtin.file:
            path: "{{ nextcloud_volume_db_data }}"
            state: absent
        - name: Create empty database folder
          ansible.builtin.file:
            path: "{{ nextcloud_volume_db_data }}"
            state: directory
            mode: "0755"

    - name: Nextcloud database
      containers.podman.podman_container:
        env:
          POSTGRES_DB: "{{ nextcloud_postgres_db }}"
          POSTGRES_PASSWORD: "{{ nextcloud_postgres_password }}"
          POSTGRES_USER: "{{ nextcloud_postgres_user }}"
          TZ: "{{ global_timezone }}"
        image: docker.io/postgres:14-alpine@sha256:a0f7890719c3c42b9f78f1ad98b2cd45aa2ee3472da12f9d2d3bfbc07f421146
        name: nextcloud-db
        volumes:
          - "{{ nextcloud_volume_db_data }}:/var/lib/postgresql/data:U,z"

    - name: Ugrade nextcloud
      ansible.builtin.command:
        cmd: podman exec --user www-data -it nextcloud-web {{ item }}
      loop:
        - php occ upgrade
        - php occ maintenance:mode --off
      changed_when: false
      when: nextcloud_db_action == "none"

- name: Nextcloud database export
  when: nextcloud_db_action == "export"
  block:
    - name: Make backup nextcloud volume folder
      ansible.builtin.file:
        path: "{{ nextcloud_volume }}/db_bak"
        state: directory
        mode: "0700"
    - name: Backup nextcloud volume # noqa: risky-file-permissions
      become: true
      ansible.builtin.copy:
        dest: "{{ nextcloud_volume }}//db_bak/{{ ansible_date_time.iso8601_basic_short }}"
        directory_mode: recursive
        group: "{{ ansible_user }}"
        mode: "0700"
        owner: "{{ ansible_user }}"
        remote_src: true
        src: "{{ nextcloud_volume_db_data }}"
    - name: Create nextcloud db dump
      changed_when: false
      ansible.builtin.shell:
        chdir: "{{ nextcloud_volume }}"
        cmd: podman exec nextcloud-db pg_dumpall -U {{ nextcloud_postgres_user }} > dump.sql
    - name: Remove nextcloud container
      containers.podman.podman_container:
        name: nextcloud-db
        state: absent

- name: Nextcloud database import
  when: nextcloud_db_action == "import"
  block:
    - name: Import db into nextcloud
      ansible.builtin.shell:
        chdir: "{{ nextcloud_volume }}"
        cmd: podman exec -i nextcloud-db psql -U {{ nextcloud_postgres_user }} < dump.sql
      register: import_output
      until: import_output.rc == 0
      retries: 10
      changed_when: false
