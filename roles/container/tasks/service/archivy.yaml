- name: Archivy
  containers.podman.podman_container:
    env:
      TZ: "{{ global_timezone }}"
    image: docker.io/uzayg/archivy:latest@sha256:ac5ff2cc1417fe7cadb9762b7de5ff3c29035723533af6de5feeaf70b263dc92
    name: archivy-web
    secrets:
      - archivy_web_config,target=/archivy/.local/share/archivy/config.yml
    volumes:
      - "{{ archivy_volume_web_data }}:/archivy/data:U,z"
      - "{{ archivy_volume_web_db }}:/archivy/.local/share/archivy:U,z"

- name: Archivy elastic search
  containers.podman.podman_container:
    env:
      ES_JAVA_OPTS: "-Xms2g -Xmx2g"
      discovery.type: single-node
      ingest.geoip.downloader.enabled: "false"
    image: docker.io/elasticsearch:7.17.10@sha256:43b9e781ebb2bd731ea3966bb816edce947e34965676046b3c0f8c17318cee72
    name: archivy-elasticsearch
    user: 1000
    volumes:
      - "{{ archivy_volume_elasticsearch_data }}:/usr/share/elasticsearch/data:U,z"

- name: Create archivy admin user
  ansible.builtin.command:
    cmd: podman exec -it archivy-web archivy create-admin {{ archivy_admin_username }} --password {{ archivy_admin_password }}
  changed_when: false
  register: command_result
  failed_when: "'FAILED' in command_result.stderr"
