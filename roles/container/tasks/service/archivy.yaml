- name: Setup Archivy
  module_defaults:
    containers.podman.podman_container:
      pod: archivy
      state: "{{ archivy_state }}"
  block:
    - name: Archivy
      containers.podman.podman_container:
        env:
          ELASTICSEARCH_ENABLED: "1"
          ELASTICSEARCH_URL: http://localhost:9200/
          FLASK_DEBUG: "0"
          PGID: 0
          PUID: 0
          TZ: "{{ global_timezone }}"
        image: docker.io/uzayg/archivy:latest@sha256:8bb09c684f3781ac9bf4786ea8060261feb6c1ba34c336bd2bb45430a2fd9a29
        name: archivy-web
        volumes:
          - "{{ archivy_web_data }}:/archivy/data:U,z"
          - "{{ archivy_web_config }}:/archivy/.local/share/archivy:U,z"

    - name: Archivy elastic search
      containers.podman.podman_container:
        env:
          discovery.type: single-node
        image: docker.io/elasticsearch:7.17.8
        name: archivy-elasticsearch
        volumes:
          - "{{ archivy_elasticsearch_data }}:/usr/share/elasticsearch/data:U,z"

    - name: Create archivy admin user
      ansible.builtin.command:
        cmd: podman exec -it archivy-web archivy create-admin {{ archivy_admin_username }} --password {{ archivy_admin_password }}
      changed_when: false
      register: command_result
      failed_when: "'FAILED' in command_result.stderr"
