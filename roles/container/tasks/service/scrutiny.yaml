- name: Init list of device
  ansible.builtin.set_fact:
    scrutiny_device_list: []

- name: Get list of symlink devices
  ansible.builtin.stat:
    path: "{{ item }}"
  loop: "{{ scrutiny_device }}"
  register: scrutiny_device_name_list

- name: Setup list of devices
  ansible.builtin.set_fact:
    scrutiny_device_list: "{{ scrutiny_device_list + [item.stat.lnk_source] }}"
  loop: "{{ scrutiny_device_name_list.results }}"
  no_log: true

- name: Scrutiny
  containers.podman.podman_container:
    cap_add:
      - SYS_ADMIN
      - SYS_RAWIO
    device: "{{ scrutiny_device_list }}"
    env:
      TZ: "{{ global_timezone }}"
    image: ghcr.io/analogj/scrutiny:v0.7.1-omnibus@sha256:2eb257af930c06ded0c5c31ee3bbb14d61f027c5e24d5666cc32d58518ce2965
    name: scrutiny
    ports:
      - "{{ scrutiny_port }}:8080"
    secrets:
      - scrutiny_config,target=/scrutiny/config/scrutiny.yaml
    volumes:
      - /run/udev:/run/udev:ro,z
