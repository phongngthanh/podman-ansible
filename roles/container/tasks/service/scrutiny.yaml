- name: Init list of device
  ansible.builtin.set_fact:
    scrutiny_device_list: []

- name: Get list of symlink devices
  ansible.builtin.stat:
    path: "{{ item }}"
  loop: "{{ scrutiny_device }}"
  register: scrutiny_device_name_list

- name: Setup list of devices
  ansible.builtin.set_fact:
    scrutiny_device_list: "{{ scrutiny_device_list + [item.stat.lnk_source] }}"
  loop: "{{ scrutiny_device_name_list.results }}"
  no_log: true

- name: Scrutiny
  containers.podman.podman_container:
    cap_add:
      - SYS_ADMIN
      - SYS_RAWIO
    device: "{{ scrutiny_device_list }}"
    env:
      TZ: "{{ global_timezone }}"
    image: ghcr.io/analogj/scrutiny:master-omnibus@sha256:3acd57617550d2966e577954999a4d3308cec0d2c735e1a1b7ec53769cfa76af
    name: scrutiny
    ports:
      - "{{ scrutiny_port }}:8080"
    state: "{{ scrutiny_state }}"
    volumes:
      - /run/udev:/run/udev:ro,z
      - "{{ scrutiny_volume_config }}/scrutiny.yaml:/scrutiny/config/scrutiny.yaml:ro,z"
