- name: Init list of device
  ansible.builtin.set_fact:
    scrutiny_device_list: []

- name: Get list of symlink devices
  ansible.builtin.stat:
    path: "{{ item }}"
  loop: "{{ scrutiny_device }}"
  register: scrutiny_device_name_list

- name: Setup list of devices
  ansible.builtin.set_fact:
    scrutiny_device_list: "{{ scrutiny_device_list + [item.stat.lnk_source] }}"
  loop: "{{ scrutiny_device_name_list.results }}"
  no_log: true

- name: Scrutiny
  containers.podman.podman_container:
    cap_add:
      - SYS_ADMIN
      - SYS_RAWIO
    device: "{{ scrutiny_device_list }}"
    image: ghcr.io/analogj/scrutiny:v0.7.1-omnibus@sha256:eb799224be7fbe23a17446ba3095da11db5f3a9b29bfb76bdc6c1b1f05abbf99
    name: scrutiny
    ports:
      - "{{ scrutiny_port }}:8080"
    secrets:
      - scrutiny_config,target=/scrutiny/config/scrutiny.yaml
    volumes:
      - /run/udev:/run/udev:ro,z
