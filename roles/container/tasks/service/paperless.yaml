- name: Paperless redis
  containers.podman.podman_container:
    name: paperless-redis
    image: docker.io/redis:7@sha256:c45b9ac48fde5e7ffc59e785719165511b1327151c392c891c2f552a83446847
    env:
      TZ: "{{ global_timezone }}"
    volumes:
      - "{{ paperless_volume_redis_data }}:/data:U,z"

- name: Paperless database
  containers.podman.podman_container:
    name: paperless-database
    image: docker.io/postgres:13-alpine@sha256:aabd695a63c5bd78e05a8c9c0f897c48e115dea1d590e10049dbf25b81349697
    env:
      POSTGRES_DB: paperless
      POSTGRES_USER: paperless
      TZ: "{{ global_timezone }}"
    secrets:
      - paperless_dbpass,type=env,target=POSTGRES_PASSWORD
    volumes:
      - "{{ paperless_volume_database_data }}:/var/lib/postgresql/data:U,z"

- name: Paperless Gotenberg
  containers.podman.podman_container:
    name: paperless-gotenberg
    image: docker.io/gotenberg/gotenberg:7.9@sha256:3c8ac8dc8227b8472ba1ae7ac99932d9fa8e80e652815d8c429b1f402fde88f9
    env:
      TZ: "{{ global_timezone }}"
    command:
      - gotenberg
      - "--chromium-disable-javascript=true"
      - "--chromium-allow-list=file:///tmp/.*"

- name: Paperless Tika
  containers.podman.podman_container:
    name: paperless-tika
    image: ghcr.io/paperless-ngx/tika:2.8.0-minimal@sha256:f849adc8694e746e36c055f81a6e2459619d3e5d6c46f713c910022e773d272a
    env:
      TZ: "{{ global_timezone }}"

# https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=682407
# Huge picture will cause gs to crash
# TODO: We need to be able to adjust the -r value of gs, but currently I'm not sure how to do it on ocrmypdf
- name: Paperless webserver
  containers.podman.podman_container:
    name: paperless-webserver
    image: ghcr.io/paperless-ngx/paperless-ngx:1.17.4@sha256:2daa90449bc5a57ce6b58792f873f0da6d09039b74caa9f89e28010e40ef770e
    env:
      PAPERLESS_DBHOST: localhost
      # PAPERLESS_OCR_IMAGE_DPI: 300
      # https://github.com/ocrmypdf/OCRmyPDF/issues/1004
      PAPERLESS_OCR_USER_ARGS: '{"oversample": 300}'
      # PAPERLESS_OCR_MAX_IMAGE_PIXELS: 7998434
      # PAPERLESS_OCR_USER_ARGS: '{"skip_big": 8}'
      PAPERLESS_OCR_SKIP_ARCHIVE_FILE: always
      PAPERLESS_REDIS: redis://localhost:6379
      PAPERLESS_TIKA_ENABLED: 1
      PAPERLESS_TIKA_ENDPOINT: http://localhost:9998
      PAPERLESS_TIKA_GOTENBERG_ENDPOINT: http://localhost:3000
      TZ: "{{ global_timezone }}"
    secrets:
      - paperless_dbpass,type=env,target=PAPERLESS_DBPASS
      - paperless_ocr_language,type=env,target=PAPERLESS_OCR_LANGUAGE
      - paperless_ocr_languages,type=env,target=PAPERLESS_OCR_LANGUAGES
      - paperless_secret_key,type=env,target=PAPERLESS_SECRET_KEY
      - paperless_url,type=env,target=PAPERLESS_URL
    healthcheck: "curl -fs -S --max-time 2 http://localhost:8000"
    healthcheck_interval: 30s
    healthcheck_timeout: 10s
    healthcheck_retries: 5
    volumes:
      - "{{ paperless_volume_webserver_data }}:/usr/src/paperless/data:U,z"
      - "{{ paperless_volume_webserver_media }}:/usr/src/paperless/media:U,z"
      - "{{ paperless_volume_webserver_export }}:/usr/src/paperless/export:U,z"
      - "{{ paperless_volume_webserver_consume }}:/usr/src/paperless/consume:U,z"
# - name: Setup paperless root user
#   ansible.builtin.expect:
#     command: podman exec -it paperless-webserver python manage.py createsuperuser
#     responses:
#       (?i)username: "{{ paperless_root_username }}"
#       (?i)email address: "{{ paperless_root_email }}"
#       (?i)password: "{{ paperless_root_password }}"
#       (?i)password \(again\): "{{ paperless_root_password }}"
