- name: Paperless redis
  containers.podman.podman_container:
    name: paperless-redis
    image: docker.io/redis:7@sha256:6ccde0cb87c24c09b1970802b10e702ab4491ac932b79f69682609787379fa42
    env:
      TZ: "{{ global_timezone }}"
    volumes:
      - "{{ paperless_volume_redis_data }}:/data:U,z"

- name: Paperless database
  containers.podman.podman_container:
    name: paperless-database
    image: docker.io/postgres:13-alpine@sha256:ace35ca529a7b68e93a8c6cb4f9bf945137293c4d284729ff2f620ca06b8ca19
    env:
      POSTGRES_DB: paperless
      POSTGRES_USER: paperless
      TZ: "{{ global_timezone }}"
    secrets:
      - paperless_dbpass,type=env,target=POSTGRES_PASSWORD
    volumes:
      - "{{ paperless_volume_database_data }}:/var/lib/postgresql/data:U,z"

- name: Paperless Gotenberg
  containers.podman.podman_container:
    name: paperless-gotenberg
    image: docker.io/gotenberg/gotenberg:7.8@sha256:78477be56f7f20d0819880c3815b56a73228b9700afcdb9958abc858f96d8280
    env:
      TZ: "{{ global_timezone }}"
    command:
      - gotenberg
      - "--chromium-disable-javascript=true"
      - "--chromium-allow-list=file:///tmp/.*"

- name: Paperless Tika
  containers.podman.podman_container:
    name: paperless-tika
    image: ghcr.io/paperless-ngx/tika:2.7.0-minimal@sha256:84f4dfe4515ad4c90bcd524d03d5aed82285ce1cdee21ebd94a09d1aeae9b97d
    env:
      TZ: "{{ global_timezone }}"

# https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=682407
# Huge picture will cause gs to crash
# TODO: We need to be able to adjust the -r value of gs, but currently I'm not sure how to do it on ocrmypdf
- name: Paperless webserver
  containers.podman.podman_container:
    name: paperless-webserver
    image: ghcr.io/paperless-ngx/paperless-ngx:1.16.4@sha256:c59bbc864fdef67cb13febc042f0f250d2fe746026d55097ab39140946d2e012
    env:
      PAPERLESS_DBHOST: localhost
      # PAPERLESS_OCR_IMAGE_DPI: 300
      # https://github.com/ocrmypdf/OCRmyPDF/issues/1004
      PAPERLESS_OCR_USER_ARGS: '{"oversample": 300}'
      # PAPERLESS_OCR_MAX_IMAGE_PIXELS: 7998434
      # PAPERLESS_OCR_USER_ARGS: '{"skip_big": 8}'
      PAPERLESS_OCR_SKIP_ARCHIVE_FILE: always
      PAPERLESS_REDIS: redis://localhost:6379
      PAPERLESS_TIKA_ENABLED: 1
      PAPERLESS_TIKA_ENDPOINT: http://localhost:9998
      PAPERLESS_TIKA_GOTENBERG_ENDPOINT: http://localhost:3000
      TZ: "{{ global_timezone }}"
    secrets:
      - paperless_dbpass,type=env,target=PAPERLESS_DBPASS
      - paperless_ocr_language,type=env,target=PAPERLESS_OCR_LANGUAGE
      - paperless_ocr_languages,type=env,target=PAPERLESS_OCR_LANGUAGES
      - paperless_secret_key,type=env,target=PAPERLESS_SECRET_KEY
      - paperless_url,type=env,target=PAPERLESS_URL
    healthcheck:
      test:
        ["CMD", "curl", "-fs", "-S", "--max-time", "2", "http://localhost:8000"]
      interval: 30s
      timeout: 10s
      retries: 5
    volumes:
      - "{{ paperless_volume_webserver_data }}:/usr/src/paperless/data:U,z"
      - "{{ paperless_volume_webserver_media }}:/usr/src/paperless/media:U,z"
      - "{{ paperless_volume_webserver_export }}:/usr/src/paperless/export:U,z"
      - "{{ paperless_volume_webserver_consume }}:/usr/src/paperless/consume:U,z"
# - name: Setup paperless root user
#   ansible.builtin.expect:
#     command: podman exec -it paperless-webserver python manage.py createsuperuser
#     responses:
#       (?i)username: "{{ paperless_root_username }}"
#       (?i)email address: "{{ paperless_root_email }}"
#       (?i)password: "{{ paperless_root_password }}"
#       (?i)password \(again\): "{{ paperless_root_password }}"
