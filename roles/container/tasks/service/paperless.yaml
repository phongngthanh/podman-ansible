- name: Paperless redis
  containers.podman.podman_container:
    name: paperless-redis
    image: docker.io/redis:7-alpine@sha256:2d148c557c85309c7cf1bbf15ebc21d5fc370ab1cb913a6c19b74bd29d10801c
    env:
      TZ: "{{ global_timezone }}"
    volumes:
      - "{{ paperless_volume_redis_data }}:/data:U,z"

- name: Paperless database
  containers.podman.podman_container:
    name: paperless-database
    image: docker.io/postgres:13-alpine@sha256:fb996e3d64cb4ea2056b840e7a3e3914c04da8ed732c1a41f986b7864a27a33b
    env:
      POSTGRES_DB: paperless
      POSTGRES_USER: paperless
      TZ: "{{ global_timezone }}"
    secrets:
      - paperless_dbpass,type=env,target=POSTGRES_PASSWORD
    volumes:
      - "{{ paperless_volume_database_data }}:/var/lib/postgresql/data:U,z"

- name: Paperless Gotenberg
  containers.podman.podman_container:
    name: paperless-gotenberg
    image: docker.io/gotenberg/gotenberg:7.9@sha256:2e4fcccf5e065bf4d92b0b69c80776505e602dbfb11618c1c4e4e8be8a0630e9
    env:
      TZ: "{{ global_timezone }}"
    command:
      - gotenberg
      - "--chromium-disable-javascript=true"
      - "--chromium-allow-list=file:///tmp/.*"

- name: Paperless Tika
  containers.podman.podman_container:
    name: paperless-tika
    image: ghcr.io/paperless-ngx/tika:2.9.0-minimal@sha256:6d75c2fe27719f0961b0100c994b0ae81b09374dfc7c142f0fd404987ef5dd59
    env:
      TZ: "{{ global_timezone }}"

# https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=682407
# Huge picture will cause gs to crash
# TODO: We need to be able to adjust the -r value of gs, but currently I'm not sure how to do it on ocrmypdf
- name: Paperless webserver
  containers.podman.podman_container:
    name: paperless-webserver
    image: ghcr.io/paperless-ngx/paperless-ngx:1.17.4@sha256:2daa90449bc5a57ce6b58792f873f0da6d09039b74caa9f89e28010e40ef770e
    env:
      PAPERLESS_DBHOST: localhost
      # PAPERLESS_OCR_IMAGE_DPI: 300
      # https://github.com/ocrmypdf/OCRmyPDF/issues/1004
      PAPERLESS_OCR_USER_ARGS: '{"oversample": 300}'
      # PAPERLESS_OCR_MAX_IMAGE_PIXELS: 7998434
      # PAPERLESS_OCR_USER_ARGS: '{"skip_big": 8}'
      PAPERLESS_OCR_SKIP_ARCHIVE_FILE: always
      PAPERLESS_REDIS: redis://localhost:6379
      PAPERLESS_TIKA_ENABLED: 1
      PAPERLESS_TIKA_ENDPOINT: http://localhost:9998
      PAPERLESS_TIKA_GOTENBERG_ENDPOINT: http://localhost:3000
      TZ: "{{ global_timezone }}"
    secrets:
      - paperless_dbpass,type=env,target=PAPERLESS_DBPASS
      - paperless_ocr_language,type=env,target=PAPERLESS_OCR_LANGUAGE
      - paperless_ocr_languages,type=env,target=PAPERLESS_OCR_LANGUAGES
      - paperless_secret_key,type=env,target=PAPERLESS_SECRET_KEY
      - paperless_url,type=env,target=PAPERLESS_URL
    healthcheck: "curl -fs -S --max-time 2 http://localhost:8000"
    healthcheck_interval: 30s
    healthcheck_timeout: 10s
    healthcheck_retries: 5
    volumes:
      - "{{ paperless_volume_webserver_data }}:/usr/src/paperless/data:U,z"
      - "{{ paperless_volume_webserver_media }}:/usr/src/paperless/media:U,z"
      - "{{ paperless_volume_webserver_export }}:/usr/src/paperless/export:U,z"
      - "{{ paperless_volume_webserver_consume }}:/usr/src/paperless/consume:U,z"
# - name: Setup paperless root user
#   ansible.builtin.expect:
#     command: podman exec -it paperless-webserver python manage.py createsuperuser
#     responses:
#       (?i)username: "{{ paperless_root_username }}"
#       (?i)email address: "{{ paperless_root_email }}"
#       (?i)password: "{{ paperless_root_password }}"
#       (?i)password \(again\): "{{ paperless_root_password }}"
