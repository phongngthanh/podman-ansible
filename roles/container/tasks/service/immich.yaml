- name: Immich component
  module_defaults:
    containers.podman.podman_container:
      pod: immich
      state: "{{ immich_state }}"
  block:
    - name: Server
      containers.podman.podman_container:
        name: immich-server
        image: docker.io/altran1502/immich-server:release@sha256:c61f6c5373efb4544db8d04e6e090b77561b71b07d4f272821a6349a18531e37
        command:
          - "/bin/sh"
          - "./start-server.sh"
        volumes:
          - "{{ immich_volume_upload }}:/usr/src/app/upload"
        env:
          DB_DATABASE_NAME: "{{ immich_database_db }}"
          DB_HOSTNAME: localhost
          DB_PASSWORD: "{{ immich_database_password }}"
          DB_USERNAME: "{{ immich_database_user }}"
          JWT_SECRET: "{{ immich_jwt_secret }}"
          NODE_ENV: production
          REDIS_HOSTNAME: localhost
          TZ: "{{ global_timezone }}"

    - name: Microservices
      containers.podman.podman_container:
        name: immich-microservices
        image: docker.io/altran1502/immich-server:release@sha256:c61f6c5373efb4544db8d04e6e090b77561b71b07d4f272821a6349a18531e37
        command:
          - "/bin/sh"
          - "./start-microservices.sh"
        volume:
          - "{{ immich_volume_upload }}:/usr/src/app/upload"
        env:
          DB_DATABASE_NAME: "{{ immich_database_db }}"
          DB_HOSTNAME: localhost
          DB_PASSWORD: "{{ immich_database_password }}"
          DB_USERNAME: "{{ immich_database_user }}"
          JWT_SECRET: "{{ immich_jwt_secret }}"
          NODE_ENV: production
          REDIS_HOSTNAME: localhost
          TZ: "{{ global_timezone }}"

    - name: Machine learning
      containers.podman.podman_container:
        name: immich-machine-learning
        image: docker.io/altran1502/immich-machine-learning:release@sha256:a5e660247a5a3c1d1b4ab9d160629def546d7e86e534a55d5ebc0e0eee5cef1a
        command:
          - "/bin/sh"
          - "./entrypoint.sh"
        volumes:
          - "{{ immich_volume_upload }}:/usr/src/app/upload"
        env:
          NODE_ENV: production
          TZ: "{{ global_timezone }}"

    - name: Web
      containers.podman.podman_container:
        name: immich-web
        image: docker.io/altran1502/immich-web:release@sha256:d6d7c604944ddcaa23fe2e1c6cfbc5666a74e8fb5d921eb0062b72ffd24fa291
        command:
          - "/bin/sh"
          - "./entrypoint.sh"
        env:
          TZ: "{{ global_timezone }}"

    - name: Redis
      containers.podman.podman_container:
        name: immich-redis
        image: docker.io/redis:6-alpine@sha256:060b852f1e697e97de3657cc026ce84e2d06d443840fe06da9f19c4564758451
        env:
          TZ: "{{ global_timezone }}"

    - name: Database
      containers.podman.podman_container:
        name: immich-database
        image: docker.io/postgres:14-alpine@sha256:4433f89a2bfbd287a0178379963d757743deeab5ef8b5027b1baf2b1825b2dc8
        env:
          POSTGRES_DB: "{{ immich_database_db }}"
          POSTGRES_PASSWORD: "{{ immich_database_password }}"
          POSTGRES_USER: "{{ immich_database_user }}"
          TZ: "{{ global_timezone }}"
        volumes:
          - "{{ immich_volume_database }}:/var/lib/postgresql/data"
