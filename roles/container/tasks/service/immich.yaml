- name: Immich Redis
  containers.podman.podman_container:
    name: immich-redis
    image: docker.io/redis:6-alpine@sha256:8c131253384920eadcae2ee0e37e8d127146c8fc39ef5319b0cccae88ec150f0
    env:
      TZ: "{{ global_timezone }}"

- name: Immich Database
  containers.podman.podman_container:
    name: immich-database
    image: docker.io/postgres:14-alpine@sha256:150dd39ccb7ae6c7ba6130c3582c39a30bb5d3d22cb08ad0ba37001e3f829abc
    env:
      POSTGRES_DB: immich
      POSTGRES_USER: immich
      TZ: "{{ global_timezone }}"
    secrets:
      - immich_postgres_db,type=env,target=POSTGRES_PASSWORD
    volumes:
      - "{{ immich_volume_database }}:/var/lib/postgresql/data"

- name: Immich Typesense
  containers.podman.podman_container:
    name: immich-typesense
    image: docker.io/typesense/typesense:0.24.1@sha256:e6ef6a082a62fb19c7fa80f596293f6519ce445670a59ae6ec4b750283865859
    env:
      TYPESENSE_DATA_DIR: /data
    secrets:
      - immich_typesense_api_key,type=env,target=TYPESENSE_API_KEY
    volumes:
      - "{{ immich_volume_typesense }}:/data:U,z"

- name: Immich Server
  containers.podman.podman_container:
    name: immich-server
    image: ghcr.io/immich-app/immich-server:release@sha256:0a0e94edf667ee677e147f24f8dc5396da6487e1a74e000b2862d45ff0e5fcbc
    command:
      - "/bin/sh"
      - "./start-server.sh"
    volumes:
      - "{{ immich_volume_upload }}:/usr/src/app/upload"
    env:
      DB_DATABASE_NAME: immich
      DB_HOSTNAME: localhost
      DB_USERNAME: immich
      NODE_ENV: production
      REDIS_HOSTNAME: localhost
      TYPESENSE_URL: "ha://{{ immich_typesense_url | to_json | b64encode }}"
      TZ: "{{ global_timezone }}"
    secrets:
      - immich_jwt_secret,type=env,target=JWT_SECRET
      - immich_postgres_db,type=env,target=DB_PASSWORD
      - immich_typesense_api_key,type=env,target=TYPESENSE_API_KEY

- name: Immich Microservices
  containers.podman.podman_container:
    name: immich-microservices
    image: ghcr.io/immich-app/immich-server:release@sha256:0a0e94edf667ee677e147f24f8dc5396da6487e1a74e000b2862d45ff0e5fcbc
    command:
      - "/bin/sh"
      - "./start-microservices.sh"
    volume:
      - "{{ immich_volume_upload }}:/usr/src/app/upload"
    env:
      DB_DATABASE_NAME: immich
      DB_HOSTNAME: localhost
      DB_USERNAME: immich
      NODE_ENV: production
      REDIS_HOSTNAME: localhost
      TYPESENSE_HOST: localhost
      TZ: "{{ global_timezone }}"
    secrets:
      - immich_jwt_secret,type=env,target=JWT_SECRET
      - immich_postgres_db,type=env,target=DB_PASSWORD
      - immich_typesense_api_key,type=env,target=TYPESENSE_API_KEY

- name: Immich Machine learning
  containers.podman.podman_container:
    name: immich-machine-learning
    image: ghcr.io/immich-app/immich-machine-learning:release@sha256:6c6ed3bf6fe01477d0da642884fa0f8162cd0ad913540b91ffac8bdca070dfbb
    volumes:
      - "{{ immich_volume_upload }}:/usr/src/app/upload"
      - "{{ immich_volume_ml_cache }}:/cache:U,z"
    env:
      NODE_ENV: production
      TZ: "{{ global_timezone }}"

- name: Immich Web
  containers.podman.podman_container:
    name: immich-web
    image: ghcr.io/immich-app/immich-web:release@sha256:f80fd29f3f30eb8133325c3bb5e578d62cb96043abe46b8546bd3a53b3f8cda7
    command:
      - "/bin/sh"
      - "./entrypoint.sh"
    env:
      TZ: "{{ global_timezone }}"
