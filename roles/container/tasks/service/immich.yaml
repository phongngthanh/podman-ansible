- name: Immich component
  module_defaults:
    containers.podman.podman_container:
      labels:
        io.containers.autoupdate: registry
      pod: immich
      state: "{{ immich_state }}"
  block:
    - name: Server
      containers.podman.podman_container:
        name: immich-server
        image: docker.io/altran1502/immich-server:release@sha256:df8ee315cc99d7b6e71fbfbfb0cbfab94ab3fcfc3a156f0bedd7291113767fcd
        command:
          - "/bin/sh"
          - "./start-server.sh"
        volumes:
          - "{{ immich_volume_upload }}:/usr/src/app/upload"
        env:
          DB_DATABASE_NAME: "{{ immich_database_db }}"
          DB_HOSTNAME: localhost
          DB_PASSWORD: "{{ immich_database_password }}"
          DB_USERNAME: "{{ immich_database_user }}"
          JWT_SECRET: "{{ immich_jwt_secret }}"
          NODE_ENV: production
          REDIS_HOSTNAME: localhost
          TZ: "{{ global_timezone }}"

    - name: Microservices
      containers.podman.podman_container:
        name: immich-microservices
        image: docker.io/altran1502/immich-server:release@sha256:df8ee315cc99d7b6e71fbfbfb0cbfab94ab3fcfc3a156f0bedd7291113767fcd
        command:
          - "/bin/sh"
          - "./start-microservices.sh"
        volume:
          - "{{ immich_volume_upload }}:/usr/src/app/upload"
        env:
          DB_DATABASE_NAME: "{{ immich_database_db }}"
          DB_HOSTNAME: localhost
          DB_PASSWORD: "{{ immich_database_password }}"
          DB_USERNAME: "{{ immich_database_user }}"
          JWT_SECRET: "{{ immich_jwt_secret }}"
          NODE_ENV: production
          REDIS_HOSTNAME: localhost
          TZ: "{{ global_timezone }}"

    - name: Machine learning
      containers.podman.podman_container:
        name: immich-machine-learning
        image: docker.io/altran1502/immich-machine-learning:release@sha256:27126721c3250c8d4ca8d42b713c56610f15113ba950f64d14f17b0cdb15d2ff
        command:
          - "/bin/sh"
          - "./entrypoint.sh"
        volumes:
          - "{{ immich_volume_upload }}:/usr/src/app/upload"
        env:
          NODE_ENV: production
          TZ: "{{ global_timezone }}"

    - name: Web
      containers.podman.podman_container:
        name: immich-web
        image: docker.io/altran1502/immich-web:release@sha256:5de4a9fbf50ffcf25f330ca8a607762a7a8c05751f29b6b190e25ff2bda40f0a
        command:
          - "/bin/sh"
          - "./entrypoint.sh"
        env:
          TZ: "{{ global_timezone }}"

    - name: Redis
      containers.podman.podman_container:
        name: immich-redis
        image: docker.io/redis:7.0-alpine@sha256:518c024ec78b3074917bad2d40863e882e5297d65587e6d7c6e0b7281d9b8270
        env:
          TZ: "{{ global_timezone }}"

    - name: Database
      containers.podman.podman_container:
        name: immich-database
        image: docker.io/postgres:14-alpine@sha256:1785b8611bb46e7b8776841be5febc322cdb84c3b72c12bfed364379ecdf9b0d
        env:
          POSTGRES_DB: "{{ immich_database_db }}"
          POSTGRES_PASSWORD: "{{ immich_database_password }}"
          POSTGRES_USER: "{{ immich_database_user }}"
          TZ: "{{ global_timezone }}"
        volumes:
          - "{{ immich_volume_database }}:/var/lib/postgresql/data"
