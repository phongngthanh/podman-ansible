- name: Immich Redis
  containers.podman.podman_container:
    name: immich-redis
    image: docker.io/redis:6-alpine@sha256:5b5474c15f4bfe14cf78b10a92ed8c0880e07b959a15ff5ba814c653c4c3c159
    env:
      TZ: "{{ global_timezone }}"

- name: Immich Database
  containers.podman.podman_container:
    name: immich-database
    image: docker.io/postgres:14-alpine@sha256:8da7e8e94d4bcc28da8f222a4e259b6f7df2dc62640d104f81762678dc1e2200
    env:
      POSTGRES_DB: immich
      POSTGRES_USER: immich
      TZ: "{{ global_timezone }}"
    secrets:
      - immich_postgres_db,type=env,target=POSTGRES_PASSWORD
    volumes:
      - "{{ immich_volume_database }}:/var/lib/postgresql/data"

- name: Immich Typesense
  containers.podman.podman_container:
    name: immich-typesense
    image: docker.io/typesense/typesense:0.25.0@sha256:568dffb34e0cedeb6205f1b0934e47c6d9c0596fc8ebba306e1828f94c1a4b7e
    env:
      TYPESENSE_DATA_DIR: /data
    secrets:
      - immich_typesense_api_key,type=env,target=TYPESENSE_API_KEY
    volumes:
      - "{{ immich_volume_typesense }}:/data:U,z"

- name: Immich Server
  containers.podman.podman_container:
    name: immich-server
    image: ghcr.io/immich-app/immich-server:v1.76.1@sha256:b1b0ef1210179ae7b98310267ef4a0d9fd6b6ba2080e08c19b6175b5ebdcec43
    command:
      - "start-server.sh"
    volumes:
      - "{{ immich_volume_upload }}:/usr/src/app/upload"
    env:
      DB_DATABASE_NAME: immich
      DB_HOSTNAME: localhost
      DB_USERNAME: immich
      NODE_ENV: production
      REDIS_HOSTNAME: localhost
      TYPESENSE_URL: "ha://{{ immich_typesense_url | to_json | b64encode }}"
      TZ: "{{ global_timezone }}"
    secrets:
      - immich_jwt_secret,type=env,target=JWT_SECRET
      - immich_postgres_db,type=env,target=DB_PASSWORD
      - immich_typesense_api_key,type=env,target=TYPESENSE_API_KEY

- name: Immich Microservices
  containers.podman.podman_container:
    name: immich-microservices
    image: ghcr.io/immich-app/immich-server:v1.76.1@sha256:b1b0ef1210179ae7b98310267ef4a0d9fd6b6ba2080e08c19b6175b5ebdcec43
    command:
      - "start-microservices.sh"
    volume:
      - "{{ immich_volume_upload }}:/usr/src/app/upload"
    env:
      DB_DATABASE_NAME: immich
      DB_HOSTNAME: localhost
      DB_USERNAME: immich
      NODE_ENV: production
      REDIS_HOSTNAME: localhost
      TYPESENSE_HOST: localhost
      TZ: "{{ global_timezone }}"
    secrets:
      - immich_jwt_secret,type=env,target=JWT_SECRET
      - immich_postgres_db,type=env,target=DB_PASSWORD
      - immich_typesense_api_key,type=env,target=TYPESENSE_API_KEY

- name: Immich Machine learning
  containers.podman.podman_container:
    name: immich-machine-learning
    image: ghcr.io/immich-app/immich-machine-learning:v1.76.1@sha256:8735463cac34ef95ad0a1f56bfc86b65153f9cd22fb2eed38faba1a1a145190f
    volumes:
      - "{{ immich_volume_upload }}:/usr/src/app/upload"
      - "immich_volume_ml_cache:/cache:U"
    env:
      NODE_ENV: production
      TZ: "{{ global_timezone }}"

- name: Immich Web
  containers.podman.podman_container:
    name: immich-web
    image: ghcr.io/immich-app/immich-web:v1.76.1@sha256:518bde84738306b056e419631fe5b5b43f025bd251e168b872b74b8d7e4a4777
    env:
      IMMICH_SERVER_URL: http://localhost:3001
      TZ: "{{ global_timezone }}"
