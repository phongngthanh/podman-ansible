- name: Immich component
  module_defaults:
    containers.podman.podman_container:
      pod: immich
      state: "{{ immich_state }}"
  block:
    - name: Server
      containers.podman.podman_container:
        name: immich-server
        image: docker.io/altran1502/immich-server:release@sha256:a6ee05b4a41b578891f16759ddbc09ae8d2d5737a7b22aff4146eee333b4bffc
        command:
          - "/bin/sh"
          - "./start-server.sh"
        volumes:
          - "{{ immich_volume_upload }}:/usr/src/app/upload"
        env:
          DB_DATABASE_NAME: "{{ immich_database_db }}"
          DB_HOSTNAME: localhost
          DB_PASSWORD: "{{ immich_database_password }}"
          DB_USERNAME: "{{ immich_database_user }}"
          JWT_SECRET: "{{ immich_jwt_secret }}"
          NODE_ENV: production
          REDIS_HOSTNAME: localhost
          TZ: "{{ global_timezone }}"

    - name: Microservices
      containers.podman.podman_container:
        name: immich-microservices
        image: docker.io/altran1502/immich-server:release@sha256:a6ee05b4a41b578891f16759ddbc09ae8d2d5737a7b22aff4146eee333b4bffc
        command:
          - "/bin/sh"
          - "./start-microservices.sh"
        volume:
          - "{{ immich_volume_upload }}:/usr/src/app/upload"
        env:
          DB_DATABASE_NAME: "{{ immich_database_db }}"
          DB_HOSTNAME: localhost
          DB_PASSWORD: "{{ immich_database_password }}"
          DB_USERNAME: "{{ immich_database_user }}"
          JWT_SECRET: "{{ immich_jwt_secret }}"
          NODE_ENV: production
          REDIS_HOSTNAME: localhost
          TZ: "{{ global_timezone }}"

    - name: Machine learning
      containers.podman.podman_container:
        name: immich-machine-learning
        image: docker.io/altran1502/immich-machine-learning:release@sha256:01d94096546bbdec80b81b298e7875dcc9755c701161db896687625d63d23c1a
        command:
          - "/bin/sh"
          - "./entrypoint.sh"
        volumes:
          - "{{ immich_volume_upload }}:/usr/src/app/upload"
        env:
          NODE_ENV: production
          TZ: "{{ global_timezone }}"

    - name: Web
      containers.podman.podman_container:
        name: immich-web
        image: docker.io/altran1502/immich-web:release@sha256:d7cd7d935440a5bad543022562f04b3efca9252361aa2a430825bd8170e92c8e
        command:
          - "/bin/sh"
          - "./entrypoint.sh"
        env:
          TZ: "{{ global_timezone }}"

    - name: Redis
      containers.podman.podman_container:
        name: immich-redis
        image: docker.io/redis:6-alpine@sha256:6536c76c861b30f2f64b38c391330813ef187cef5f773dc58b5646230cc0afc5
        env:
          TZ: "{{ global_timezone }}"

    - name: Database
      containers.podman.podman_container:
        name: immich-database
        image: docker.io/postgres:14-alpine@sha256:a0f7890719c3c42b9f78f1ad98b2cd45aa2ee3472da12f9d2d3bfbc07f421146
        env:
          POSTGRES_DB: "{{ immich_database_db }}"
          POSTGRES_PASSWORD: "{{ immich_database_password }}"
          POSTGRES_USER: "{{ immich_database_user }}"
          TZ: "{{ global_timezone }}"
        volumes:
          - "{{ immich_volume_database }}:/var/lib/postgresql/data"
