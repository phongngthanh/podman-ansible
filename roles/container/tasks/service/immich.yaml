- name: Immich component
  module_defaults:
    containers.podman.podman_container:
      pod: immich
      state: "{{ immich_state }}"
  block:
    - name: Server
      containers.podman.podman_container:
        name: immich-server
        image: docker.io/altran1502/immich-server:release@sha256:a6ee05b4a41b578891f16759ddbc09ae8d2d5737a7b22aff4146eee333b4bffc
        command:
          - "/bin/sh"
          - "./start-server.sh"
        volumes:
          - "{{ immich_volume_upload }}:/usr/src/app/upload"
        env:
          DB_DATABASE_NAME: "{{ immich_database_db }}"
          DB_HOSTNAME: localhost
          DB_PASSWORD: "{{ immich_database_password }}"
          DB_USERNAME: "{{ immich_database_user }}"
          JWT_SECRET: "{{ immich_jwt_secret }}"
          NODE_ENV: production
          REDIS_HOSTNAME: localhost
          TZ: "{{ global_timezone }}"

    - name: Microservices
      containers.podman.podman_container:
        name: immich-microservices
        image: docker.io/altran1502/immich-server:release@sha256:a6ee05b4a41b578891f16759ddbc09ae8d2d5737a7b22aff4146eee333b4bffc
        command:
          - "/bin/sh"
          - "./start-microservices.sh"
        volume:
          - "{{ immich_volume_upload }}:/usr/src/app/upload"
        env:
          DB_DATABASE_NAME: "{{ immich_database_db }}"
          DB_HOSTNAME: localhost
          DB_PASSWORD: "{{ immich_database_password }}"
          DB_USERNAME: "{{ immich_database_user }}"
          JWT_SECRET: "{{ immich_jwt_secret }}"
          NODE_ENV: production
          REDIS_HOSTNAME: localhost
          TZ: "{{ global_timezone }}"

    - name: Machine learning
      containers.podman.podman_container:
        name: immich-machine-learning
        image: docker.io/altran1502/immich-machine-learning:release@sha256:6b5dfe18d4af1eb99698d14e25bb1c922fb64dcca41f69f14344e5a3325e45ab
        command:
          - "/bin/sh"
          - "./entrypoint.sh"
        volumes:
          - "{{ immich_volume_upload }}:/usr/src/app/upload"
        env:
          NODE_ENV: production
          TZ: "{{ global_timezone }}"

    - name: Web
      containers.podman.podman_container:
        name: immich-web
        image: docker.io/altran1502/immich-web:release@sha256:14ee0ec2204674654761e29f6e560e7e633d9d21b52c4392379ff1462dd9be9c
        command:
          - "/bin/sh"
          - "./entrypoint.sh"
        env:
          TZ: "{{ global_timezone }}"

    - name: Redis
      containers.podman.podman_container:
        name: immich-redis
        image: docker.io/redis:6-alpine@sha256:060b852f1e697e97de3657cc026ce84e2d06d443840fe06da9f19c4564758451
        env:
          TZ: "{{ global_timezone }}"

    - name: Database
      containers.podman.podman_container:
        name: immich-database
        image: docker.io/postgres:14-alpine@sha256:227489bb86edc9641bc02a5ddbab02f08dd916b14b0d99d688e91fefded97f47
        env:
          POSTGRES_DB: "{{ immich_database_db }}"
          POSTGRES_PASSWORD: "{{ immich_database_password }}"
          POSTGRES_USER: "{{ immich_database_user }}"
          TZ: "{{ global_timezone }}"
        volumes:
          - "{{ immich_volume_database }}:/var/lib/postgresql/data"
