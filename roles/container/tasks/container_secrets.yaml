- name: Check if secret exists {{ container_secrets_loop.key }}
  changed_when: false
  ansible.builtin.command:
    cmd: podman secret exists {{ container_secrets_loop.key }}
  failed_when: false
  register: container_secret_state

- name: Check if secret is different {{ container_secrets_loop.key }}
  when: container_secret_state.rc == 0
  block:
    - name: Get the current secret {{ container_secrets_loop.key }}
      changed_when: false
      containers.podman.podman_container:
        name: showmysecret
        image: docker.io/busybox
        secrets:
          - "{{ container_secrets_loop.key }}"
        detach: false
        remove: true
        command: "cat /run/secrets/{{ container_secrets_loop.key }}"
      register: container_secret
    - name: Check secret templates
      when: container_secrets_loop.value.type == 'templates'
      block:
        - name: Switch on restart flag {{ container_secrets_loop.key }}
          when: (container_secret.stdout != lookup('ansible.builtin.template', container_secrets_loop.value.value))
          ansible.builtin.set_fact:
            container_restart_systemd: true
    - name: Check secret templates
      when: container_secrets_loop.value.type == 'values'
      block:
        - name: Switch on restart flag {{ container_secrets_loop.key }}
          when: (container_secret.stdout != container_secrets_loop.value.value)
          ansible.builtin.set_fact:
            container_restart_systemd: true

- name: Create secret templates {{ container_secrets_loop.key }}
  changed_when: false
  when: container_secrets_loop.value.type == 'templates'
  containers.podman.podman_secret:
    name: "{{ container_secrets_loop.key }}"
    data: "{{ lookup('ansible.builtin.template', container_secrets_loop.value.value) }}"
    force: true

- name: Create secret values {{ container_secrets_loop.key }}
  changed_when: false
  when: container_secrets_loop.value.type == 'values'
  containers.podman.podman_secret:
    name: "{{ container_secrets_loop.key }}"
    data: "{{ container_secrets_loop.value.value }}"
    force: true
