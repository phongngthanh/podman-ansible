- name: Check if secret exists {{ container_secrets_loop.key }}
  changed_when: false
  ansible.builtin.command:
    cmd: podman secret exists {{ container_secrets_loop.key }}
  failed_when: false
  register: container_secret_state

- name: Check if secret is different {{ container_secrets_loop.key }}
  when: container_secret_state.rc == 0
  block:
    - name: Get the current secret {{ container_secrets_loop.key }}
      changed_when: false
      containers.podman.podman_container:
        name: showmysecret
        image: docker.io/busybox
        secrets:
          - "{{ container_secrets_loop.key }}"
        detach: false
        remove: true
        command: "cat /run/secrets/{{ container_secrets_loop.key }}"
      register: container_secret
    - name: Check secret template
      when: container_secrets_loop.value.type == 'template'
      block:
        - name: Switch on restart flag secret template {{ container_secrets_loop.key }}
          when: (container_secret.stdout != lookup('ansible.builtin.template', container_secrets_loop.value.value))
          ansible.builtin.set_fact:
            container_recreate: true
    - name: Check secret value
      when: container_secrets_loop.value.type == 'values'
      block:
        - name: Switch on restart flag secret value {{ container_secrets_loop.key }}
          when: (container_secret.stdout != container_secrets_loop.value.value)
          ansible.builtin.set_fact:
            container_recreate: true
    - name: Check secret json
      when: container_secrets_loop.value.type == 'json'
      block:
        - name: Switch on restart flag secret json {{ container_secrets_loop.key }}
          when: (container_secret.stdout != container_secrets_loop.value.value | to_nice_json)
          ansible.builtin.set_fact:
            container_recreate: true

- name: Create secret template {{ container_secrets_loop.key }}
  changed_when: false
  when: container_secrets_loop.value.type == 'template'
  containers.podman.podman_secret:
    name: "{{ container_secrets_loop.key }}"
    data: "{{ lookup('ansible.builtin.template', container_secrets_loop.value.value) }}"
    force: true
  no_log: true

- name: Create secret values {{ container_secrets_loop.key }}
  changed_when: false
  when: container_secrets_loop.value.type == 'value'
  containers.podman.podman_secret:
    name: "{{ container_secrets_loop.key }}"
    data: "{{ container_secrets_loop.value.value }}"
    force: true
  no_log: true

# Yaml does not seem to need this
- name: Create secret json {{ container_secrets_loop.key }}
  changed_when: false
  when: container_secrets_loop.value.type == 'json'
  containers.podman.podman_secret:
    name: "{{ container_secrets_loop.key }}"
    data: "{{ container_secrets_loop.value.value | to_nice_json }}"
    force: true
  no_log: true
