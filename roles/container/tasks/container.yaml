- name: Setup systemd container {{ container_loop_var.key }}
  when: not container_loop_var.value.dashy_only
  tags:
    - "{{ container_loop_var.key }}"
  block:
    - name: Setup variable for user scope {{ container_loop_var.key }}
      ansible.builtin.set_fact:
        container_quadlet_path: "{{ ansible_user_dir }}/.config/containers/systemd"
        container_systemd_scope: user
      when: not container_loop_var.value.become

    - name: Setup variable for system scope {{ container_loop_var.key }}
      ansible.builtin.set_fact:
        container_quadlet_path: /etc/containers/systemd
        container_systemd_scope: system
      when: container_loop_var.value.become

    - name: Setup systemd container {{ container_loop_var.key }}
      become: "{{ container_loop_var.value.become }}"
      block:
        - name: Setup podman container {{ container_loop_var.key }}
          when: container_loop_var.value.state == "started"
          block:
            - name: Check if folder exists {{ container_loop_var.key }}
              ansible.builtin.stat:
                path: "{{ item }}"
              loop: "{{ container_loop_var.value.folder }}"
              register: container_folder_state
            - name: Prepare folder {{ container_loop_var.key }}
              when: not container_folder_state.skipped
              become_method: containers.podman.podman_unshare
              become: true
              ansible.builtin.file:
                path: "{{ item }}"
                mode: "0755"
                state: directory
              loop: "{{ container_folder_state.results | json_query('[?stat.exists == `false`].item') }}"

        - name: Setup container with quadlet {{ container_loop_var.key }}
          block:
            - name: Check if custom setup flow exists {{ container_loop_var.key }}
              delegate_to: localhost
              ansible.builtin.stat:
                path: roles/container/tasks/service/{{ container_loop_var.key }}.yaml
              register: custom_setup_flow
            - name: Create container with custom flow {{ container_loop_var.key }}
              when:
                - custom_setup_flow.stat.exists
                - container_loop_var.value.state == "started"
                - container_loop_var.value.postgres_action == "none"
              ansible.builtin.include_tasks:
                file: service/{{ container_loop_var.key }}.yaml
            - name: Setup container {{ container_loop_var.key }}
              when: not custom_setup_flow.stat.exists or container_loop_var.value.state == "absent" or container_loop_var.value.postgres_action != "none"
              ansible.builtin.include_tasks:
                file: container_quadlet.yaml
            - name: Setup postgres {{ container_loop_var.key }}
              when: container_loop_var.value.postgres_action != "none"
              ansible.builtin.include_tasks:
                file: container_postgres.yaml
