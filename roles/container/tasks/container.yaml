- name: Setup systemd container {{ container_loop_var.key }}
  tags:
    - "{{ container_loop_var.key }}"
  block:
    - name: Setup variable for user scope {{ container_loop_var.key }}
      ansible.builtin.set_fact:
        systemd_service_path: "{{ ansible_user_dir }}/.config/systemd/user"
        systemd_scope: user
      when: not container_loop_var.value.become

    - name: Setup variable for system scope {{ container_loop_var.key }}
      ansible.builtin.set_fact:
        systemd_service_path: /etc/systemd/system
        systemd_scope: system
      when: container_loop_var.value.become

    - name: Setup pod for service {{ container_loop_var.key }}
      ansible.builtin.set_fact:
        final_pod: "{{ container_loop_var.value.pod }}"
      when: not container_loop_var.value.timer

    - name: Do not setup pod if service is timer {{ container_loop_var.key }}
      ansible.builtin.set_fact:
        final_pod: false
      when: container_loop_var.value.timer

    - name: Setup systemd container {{ container_loop_var.key }}
      become: "{{ container_loop_var.value.become }}"
      block:
        - name: Setup podman container with systemd
          when: container_loop_var.value.state == "started"
          module_defaults:
            ansible.builtin.systemd:
              name: "{{ container_loop_var.key }}"
              daemon_reload: true
              scope: "{{ systemd_scope }}"
            containers.podman.podman_pod:
              name: "{{ container_loop_var.key }}"
              infra_name: "{{ container_loop_var.key }}-pod"
              network: caddy
              state: "{{ container_loop_var.value.state }}"
          block:
            - name: Check if folder exists {{ container_loop_var.key }}
              ansible.builtin.stat:
                path: "{{ item }}"
              loop: "{{ container_loop_var.value.folder }}"
              register: folder_state
            - name: Prepare folder {{ container_loop_var.key }}
              module_defaults:
                ansible.builtin.file:
                  path: "{{ item }}"
                  state: directory
              when: not folder_state.skipped
              block:
                - name: Prepare folder if not exists {{ container_loop_var.key }}
                  ansible.builtin.file:
                    owner: "{{ ansible_user }}"
                    group: "{{ ansible_user }}"
                    mode: "0755"
                  loop: "{{ container_loop_var.value.folder }}"
                  when: not folder_state.results[0].stat.exists
                - name: Preserve folder if already exists {{ container_loop_var.key }} # noqa: risky-file-permissions
                  become: true
                  ansible.builtin.file:
                  loop: "{{ container_loop_var.value.folder }}"
                  when: folder_state.results[0].stat.exists
            - name: Templates config file
              ansible.builtin.include_tasks:
                file: container_templates.yaml
              loop: "{{ container_loop_var.value.templates }}"
              loop_control:
                loop_var: container_templates_loop_var
              register: restart_systemd
            - name: Run service with pod {{ container_loop_var.key }}
              become: "{{ container_loop_var.value.become }}"
              module_defaults:
                containers.podman.podman_container:
                  pod: "{{ container_loop_var.key }}"
                  state: "{{ container_loop_var.value.state }}"
              when: final_pod
              block:
                - name: Create pod {{ container_loop_var.key }}
                  ansible.builtin.import_tasks: container_pod.yaml
              rescue:
                - name: Delete pod {{ container_loop_var.key }}
                  containers.podman.podman_pod:
                    name: "{{ container_loop_var.key }}"
                    state: absent
                - name: Create pod {{ container_loop_var.key }}
                  ansible.builtin.import_tasks: container_pod.yaml
            - name: Run service without pod {{ container_loop_var.key }}
              become: "{{ container_loop_var.value.become }}"
              when: not final_pod
              module_defaults:
                containers.podman.podman_container:
                  state: "{{ container_loop_var.value.state }}"
              ansible.builtin.import_tasks: "service/{{ container_loop_var.key }}.yaml"
            - name: Create systemd service file for {{ container_loop_var.key }}
              containers.podman.podman_generate_systemd:
                container_prefix: ""
                dest: "{{ systemd_service_path }}"
                name: "{{ container_loop_var.key }}"
                no_header: true
                pod_prefix: ""
                separator: ""
            # Need this since handlers doesn't work with include. Issues: https://github.com/ansible/ansible/issues/19765
            - name: Restart if config files are changed {{ container_loop_var.key }}
              ansible.builtin.systemd:
                state: restarted
              when: restart_systemd.changed
            - name: Enable systemd {{ container_loop_var.key }}
              ansible.builtin.systemd:
                enabled: true
                state: "{{ container_loop_var.value.state }}"
              register: service
              until: service.failed == false
              when: container_loop_var.value.timer == ''
            - name: Setup systemd timer {{ container_loop_var.key }}
              when: container_loop_var.value.timer
              block:
                - name: Setup systemd timer {{ container_loop_var.key }}
                  ansible.builtin.include_role:
                    name: systemd_timer
                  vars:
                    systemd_timer_name: "{{ container_loop_var.key }}"
                    systemd_timer_become: "{{ container_loop_var.value.become }}"
                    systemd_timer_schedule: "{{ container_loop_var.value.timer }}"
                    systemd_timer_state: "{{ container_loop_var.value.state }}"

        - name: Stop podman container
          when: container_loop_var.value.state == "absent"
          module_defaults:
            ansible.builtin.systemd:
              name: "{{ container_loop_var.key }}"
              daemon_reload: true
              enabled: false
              scope: "{{ systemd_scope }}"
              state: stopped
          vars:
            systemd_file_list: ["{{ container_loop_var.key }}"]
          block:
            - name: Check if systemd file for container exists {{ container_loop_var.key }}
              ansible.builtin.stat:
                path: "{{ systemd_service_path }}/{{ container_loop_var.key }}.service"
              register: systemd_service_file_state
            - name: Setup systemd file list {{ container_loop_var.key }}
              when:
                - systemd_service_file_state.stat.exists
              block:
                - name: Setup systemd file list for pod {{ container_loop_var.key }}
                  when: final_pod
                  block:
                    - name: Get a list of systemd files {{ container_loop_var.key }}
                      containers.podman.podman_pod_info:
                        name: "{{ container_loop_var.key }}"
                      register: pod_info
                    - name: Set list of systemd files {{ container_loop_var.key }}
                      ansible.builtin.set_fact:
                        systemd_file_list: "{{ systemd_file_list + [item.Name] }}"
                      loop: "{{ pod_info.pods[0].Containers }}"

                - name: Stop systemd service {{ container_loop_var.key }}
                  ansible.builtin.systemd:
                - name: Remove systemd files {{ container_loop_var.key }}
                  ansible.builtin.file:
                    path: "{{ systemd_service_path }}/{{ item }}.service"
                    state: absent
                  loop: "{{ systemd_file_list }}"
                - name: Remove systemd timer
                  when: container_loop_var.value.timer != ''
                  ansible.builtin.file:
                    path: "{{ systemd_service_path }}/{{ container_loop_var.key }}.timer"
