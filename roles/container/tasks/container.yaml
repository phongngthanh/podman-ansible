- name: Setup systemd container {{ container_loop_var.key }}
  tags:
    - "{{ container_loop_var.key }}"
  block:
    - name: Setup variable for user scope {{ container_loop_var.key }}
      ansible.builtin.set_fact:
        container_systemd_path: "{{ ansible_user_dir }}/.config/systemd/user"
        container_systemd_scope: user
      when: not container_loop_var.value.become

    - name: Setup variable for system scope {{ container_loop_var.key }}
      ansible.builtin.set_fact:
        container_systemd_path: /etc/systemd/system
        container_systemd_scope: system
      when: container_loop_var.value.become

    - name: Setup pod for service {{ container_loop_var.key }}
      ansible.builtin.set_fact:
        container_final_pod: "{{ container_loop_var.value.pod }}"
      when: not container_loop_var.value.timer

    - name: Do not setup pod if service is timer {{ container_loop_var.key }}
      ansible.builtin.set_fact:
        container_final_pod: false
      when: container_loop_var.value.timer

    - name: Setup systemd container {{ container_loop_var.key }}
      become: "{{ container_loop_var.value.become }}"
      block:
        - name: Setup podman container with systemd
          when: container_loop_var.value.state == "started"
          block:
            - name: Check if folder exists {{ container_loop_var.key }}
              ansible.builtin.stat:
                path: "{{ item }}"
              loop: "{{ container_loop_var.value.folder }}"
              register: container_folder_state
            - name: Prepare folder {{ container_loop_var.key }}
              when: not container_folder_state.skipped
              ansible.builtin.include_tasks:
                file: container_folder.yaml
              loop: "{{ container_folder_state.results }}"
              loop_control:
                loop_var: container_folder_loop
            - name: Set container default restart state
              ansible.builtin.set_fact:
                container_recreate: false
            - name: Create secrets {{ container_loop_var.key }}
              when: container_loop_var.value.secrets
              ansible.builtin.include_tasks:
                file: container_secrets.yaml
              loop: "{{ container_loop_var.value.secrets | dict2items }}"
              loop_control:
                loop_var: container_secrets_loop
              no_log: true
            - name: Create volume {{ container_loop_var.key }}
              when: container_loop_var.value.volume
              containers.podman.podman_volume:
                name: "{{ item }}"
              loop: "{{ container_loop_var.value.volume }}"

        - name: Setup container with generate systemd {{ container_loop_var.key }}
          when: not container_loop_var.value.quadlet
          ansible.builtin.include_tasks:
            file: container_systemd.yaml
