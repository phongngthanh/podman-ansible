- name: Create Caddy config folder
  file:
    path: '{{ caddy_data_config }}'
    state: directory
- name: Create Caddy data folder
  file:
    path: '{{ caddy_data_data }}'
    state: directory

- name: Caddyfile
  copy:
    src: 'caddy/Caddyfile'
    dest: '{{ caddy_data_caddyfile }}'
  notify:
  - Restart Caddy

- name: Caddy
  containers.podman.podman_container:
    name: caddy
    image: 'caddy:{{ caddy_tag }}'
    env:
      CADDYFILE_PROXY_SITE: '{{ caddy_caddyfile_proxy_site }}'
      CADDYFILE_HOST_ADDRESS: '{{ caddy_caddyfile_host_address }}'
      CADDYFILE_BASIC_AUTH_USER: '{{ caddy_caddyfile_basic_auth_user }}'
      CADDYFILE_BASIC_AUTH_PASS: '{{ caddy_caddyfile_basic_auth_pass }}'
      CADDYFILE_AUTH_TOKEN: '{{ caddy_caddyfile_auth_token }}'
    network:
      - caddy
    ports:
      - '10080:80/tcp'
      - '10443:443/tcp'
      - '10443:443/udp'
    volumes:
      - '/etc/localtime:/etc/localtime:ro,z'
      - '{{ caddy_data_caddyfile }}:/etc/caddy/Caddyfile:U,ro,z'
      - '{{ caddy_data_config }}:/config:U,z'
      - '{{ caddy_data_data }}:/data:U,z'
    restart_policy: 'on-failure:3'
    recreate: yes
    state: '{{ caddy_state }}'