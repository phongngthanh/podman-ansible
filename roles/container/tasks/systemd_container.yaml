- name: Setup podman container with systemd
  tags:
    - "{{ systemd_container_loop_var.key }}"
  when: systemd_container_loop_var.value.state == "started"
  block:
    - name: Prepare {{ systemd_container_loop_var.key }} folder
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
      loop: "{{ systemd_container_loop_var.value.folder }}"

    - name: Templates {{ systemd_container_loop_var.key }} config files
      ansible.builtin.template:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0600"
      loop: "{{ systemd_container_loop_var.value.templates }}"
      register: restart_systemd
      become: true
      when: systemd_container_loop_var.value.templates is defined

    - name: Check if systemd file for container exists
      ansible.builtin.stat:
        path: /home/{{ ansible_user }}/.config/systemd/user/{{ systemd_container_loop_var.key }}.service
      register: systemd_service_file_status

    - name: Stop {{ systemd_container_loop_var.key }} systemd
      ansible.builtin.systemd:
        name: "{{ systemd_container_loop_var.key }}"
        daemon_reload: true
        enabled: true
        scope: user
        state: stopped
      when: systemd_service_file_status.stat.exists

    - name: Create {{ systemd_container_loop_var.key }} pod
      containers.podman.podman_pod:
        infra_name: "{{ systemd_container_loop_var.key }}-pod"
        name: "{{ systemd_container_loop_var.key }}"
        network: caddy
        state: "{{ systemd_container_loop_var.value.state }}"
      when: >
        ( (not systemd_container_loop_var.value.pod is defined)  or (systemd_container_loop_var.value.pod) ) and  (systemd_container_loop_var.value.state == "started")


    - name: Create {{ systemd_container_loop_var.key }} container
      import_tasks: "service/{{ systemd_container_loop_var.key }}.yaml"

    - name: Create pod {{ systemd_container_loop_var.key }} systemd
      containers.podman.podman_pod:
        name: "{{ systemd_container_loop_var.key }}"
        infra_name: "{{ systemd_container_loop_var.key }}-pod"
        network: caddy
        generate_systemd:
          container_prefix: ""
          new: true
          path: /home/{{ ansible_user }}/.config/systemd/user
          pod_prefix: ""
          separator: ""
        state: "{{ systemd_container_loop_var.value.state }}"
      when: >
        ( (not systemd_container_loop_var.value.pod is defined) or (systemd_container_loop_var.value.pod) ) and  (systemd_container_loop_var.value.state == "started")


    # Need this since handlers doesn't work with include. Issues: https://github.com/ansible/ansible/issues/19765
    - name: Restart {{ systemd_container_loop_var.key }} if config files are changed
      ansible.builtin.systemd:
        name: "{{ systemd_container_loop_var.key }}"
        daemon_reload: true
        enabled: true
        scope: user
        state: restarted
      register: service
      until: service.failed == false
      when:
        - systemd_container_loop_var.value.state == "started"
        - restart_systemd.changed

    - name: Enable {{ systemd_container_loop_var.key }} systemd
      ansible.builtin.systemd:
        name: "{{ systemd_container_loop_var.key }}"
        daemon_reload: true
        enabled: true
        scope: user
        state: "{{ systemd_container_loop_var.value.state }}"
      register: service
      until: service.failed == false
      when: systemd_container_loop_var.value.state == "started"

    - name: Reset restart_systemd variable
      ansible.builtin.set_fact:
        restart_sytemd:
          changed: false
