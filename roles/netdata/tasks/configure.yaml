- name: Configure netdata # noqa: args[module]
  become: true
  community.general.ini_file:
    path: /etc/netdata/netdata.conf
    section: "{{ item.section }}"
    option: "{{ item.option }}"
    value: "{{ item.value }}"
    state: "{{ item.state }}"
    mode: "0644"
  loop: "{{ netdata_config }}"
  notify: Restart Netdata

- name: Check if nvidia-smi is installed
  tags: nvidia
  ansible.builtin.stat:
    path: /usr/bin/nvidia-smi
  register: nvidia_smi_state

- name: Add nvidia monitoring if nvidia driver is installed
  tags: nvidia
  become: true
  when: nvidia_smi_state.stat.exists
  block:
    - name: Copy default python monitor configuration
      changed_when: false
      ansible.builtin.command:
        chdir: "{{ netdata_root }}/usr/lib/netdata/conf.d"
        cmd: cp python.d.conf {{ netdata_root }}/etc/netdata/python.d.conf
    - name: Enable nvidia monitoring
      ansible.builtin.lineinfile:
        path: "{{ netdata_root }}/etc/netdata/python.d.conf"
        regexp: "^#nvidia_smi: yes$"
        line: "nvidia_smi: yes"
    - name: Restart netdata
      ansible.builtin.systemd:
        name: netdata
        state: restarted
        daemon_reload: true
        enabled: true
