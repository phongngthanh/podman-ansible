- name: Configure netdata # noqa: args[module] risky-file-permissions
  become: true
  community.general.ini_file:
    path: /etc/netdata/netdata.conf
    section: "{{ item.section }}"
    option: "{{ item.option }}"
    value: "{{ item.value }}"
    state: "{{ item.state }}"
  loop: "{{ netdata_config }}"
  notify: Restart Netdata

- name: Check if nvidia-smi is installed
  tags: nvidia
  ansible.builtin.stat:
    path: /usr/bin/nvidia-smi
  register: nvidia_smi_state

- name: Add nvidia monitoring if nvidia driver is installed
  tags: nvidia
  become: true
  when: nvidia_smi_state.stat.exists
  block:
    - name: Check if previous configs differ netdata
      ansible.builtin.copy:
        remote_src: true
        mode: "0600"
        src: "{{ netdata_root }}/usr/lib/netdata/conf.d/python.d.conf"
        dest: "{{ netdata_root }}/etc/netdata/python.d.conf.default"
      register: netdata_default_config_state
    - name: Copy default python monitor configuration
      ansible.builtin.copy:
        remote_src: true
        mode: "0600"
        src: "{{ netdata_root }}/usr/lib/netdata/conf.d/python.d.conf"
        dest: "{{ netdata_root }}/etc/netdata/python.d.conf"
      when: netdata_default_config_state.changed
    - name: Enable nvidia monitoring
      ansible.builtin.lineinfile:
        path: "{{ netdata_root }}/etc/netdata/python.d.conf"
        regexp: "^# nvidia_smi: yes$"
        line: "nvidia_smi: yes"
      notify: Restart Netdata
