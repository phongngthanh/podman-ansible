- name: Configure netdata
  become: true
  community.general.ini_file:
    path: /etc/netdata/netdata.conf
    section: "{{ item.section }}"
    option: "{{ item.option }}"
    value: "{{ item.value }}"
    state: "{{ item.state }}"
  loop: "{{ netdata_config }}"
  notify: Restart Netdata

- name: Check if nvidia-smi is installed
  tags: nvidia
  ansible.builtin.stat:
    path: /usr/bin/nvidia-smi
  register: nvidia_smi_state

- name: Add nvidia monitoring if nvidia driver is installed
  tags: nvidia
  become: true
  when: nvidia_smi_state.stat.exists
  block:
    - ansible.builtin.set_fact:
        netdata_root: /opt/netdata
    - name: Copy default python monitor configuration
      ansible.builtin.command:
        chdir: "{{ netdata_root }}/usr/lib/netdata/conf.d"
        cmd: cp python.d.conf {{ netdata_root }}/etc/netdata/python.d.conf
    # Could edit yaml file this way, but it removes all the comments in the file
    # - name: Edit configuration file
    #   ansible.builtin.import_role:
    #     name: common
    #     tasks_from: yaml_edit
    #   vars:
    #     yaml_file_path: "{{ netdata_root }}/usr/lib/netdata/python.d.conf"
    #     yaml_edit:
    #       nvidia_smi: yes
    - name: Enable nvidia monitoring
      ansible.builtin.lineinfile:
        path: "{{ netdata_root }}/etc/netdata/python.d.conf"
        regexp: "^#nvidia_smi: yes$"
        line: "nvidia_smi: yes"
    - name: Restart netdata
      ansible.builtin.systemd:
        name: netdata
        state: restarted
        daemon_reload: true
        enabled: true
